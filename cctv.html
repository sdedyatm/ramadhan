<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>CCTV Traffic Pro Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>

  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      max-height: 320px;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 16px 35px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .video-wrapper video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: #000;
    }

    .custom-scroll::-webkit-scrollbar {
      width: 4px;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
      background: #1e293b;
      border-radius: 10px;
    }

    .submenu-container {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 0;
      overflow: hidden;
      opacity: 0;
    }

    .submenu-container.open {
      max-height: 800px;
      opacity: 1;
      margin-top: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .active-btn {
      border-left: 4px solid #3b82f6 !important;
      background: rgba(59, 130, 246, 0.15) !important;
      color: #60a5fa !important;
    }

    #error-overlay {
      display: none;
    }

    #play-overlay {
      display: none;
    }

    @keyframes pulse-green {

      0%,
      100% {
        box-shadow: 0 0 8px #22c55e;
      }

      50% {
        box-shadow: 0 0 16px #22c55e, 0 0 24px #22c55e;
      }
    }

    #connection-dot {
      animation: pulse-green 2s infinite;
    }

    #proxy-banner {
      padding: 5px 12px;
      background: rgba(34, 197, 94, 0.1);
      border-bottom: 1px solid rgba(34, 197, 94, 0.3);
      font-size: 9px;
      font-family: monospace;
      color: #16a34a;
      text-align: center;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    @media (max-width: 768px) {
      .submenu-container button {
        min-height: 48px;
      }

      .category-group>button {
        min-height: 56px;
      }
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 h-screen flex flex-col overflow-hidden font-sans">

  <header class="p-4 bg-slate-900/90 backdrop-blur-md border-b border-slate-800 flex justify-between items-center z-30 flex-shrink-0">
    <div class="flex items-center gap-3">
      <div class="p-2 bg-blue-600 rounded-lg shadow-lg shadow-blue-900/20">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="2" />
        </svg>
      </div>
      <div>
        <h1 class="text-sm font-black tracking-tighter uppercase">CCTV<span class="text-blue-500">ATM</span></h1>
        <p id="status-bar" class="text-[9px] text-slate-500 font-mono tracking-widest uppercase">Initializing System...</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="app.toggleProxy()" id="proxy-toggle-btn" class="px-2 py-1 rounded text-[9px] font-mono uppercase tracking-widest border transition-all border-slate-700 text-slate-500 hover:border-blue-500 hover:text-blue-400" title="Toggle CORS Proxy">
        PROXY: <span id="proxy-status-label">OFF</span>
      </button>
      <div id="connection-dot" class="w-2 h-2 rounded-full bg-green-500"></div>
    </div>
  </header>

  <div id="proxy-banner">

  </div>

  <main class="flex-1 flex flex-col md:flex-row overflow-hidden min-h-0">

    <section class="p-4 md:p-6 flex flex-col items-center bg-slate-950 md:flex-1 justify-start md:justify-center border-b md:border-b-0 md:border-r border-slate-900 flex-shrink-0">
      <div class="video-wrapper group w-full max-w-2xl" id="video-box">

        <div class="absolute top-3 right-3 z-30 opacity-40 hover:opacity-100 transition-opacity">
          <img src="https://lh3.googleusercontent.com/pw/AP1GczM7DIcF6n6QmapKYKmLrjE1jfdzglHj5YotQm27QErAplykPvCq3qZDbhw3qfrzTenf75srCib_6DH_WMZ-9OioIbjLVf8zb9ehkfA6GeGPPTa8wYiNTO4BvdS0VnMemmusXQsUTJB_S1FvKaNr2p3BRA=w600-h600-s-no-gm?authuser=0" class="w-10 h-10 grayscale shadow-lg" alt="Logo">
        </div>

        <video id="main-video" class="w-full h-full" playsinline webkit-playsinline x5-playsinline x5-video-player-type="h5" x5-video-player-fullscreen="false" autoplay muted preload="none"></video>

        <!-- Overlay tombol PLAY manual untuk Android -->
        <div id="play-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/80 z-50 gap-4 cursor-pointer" onclick="app.manualPlay()">
          <div class="w-20 h-20 rounded-full bg-blue-600/90 flex items-center justify-center shadow-2xl border-2 border-blue-400/40 hover:scale-110 transition-transform active:scale-95">
            <svg class="w-10 h-10 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z" />
            </svg>
          </div>
          <p class="text-[11px] font-mono text-slate-400 uppercase tracking-widest">Tap untuk mulai streaming</p>
        </div>

        <!-- Error Overlay -->
        <div id="error-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/95 z-50 gap-3 px-6">
          <div class="text-3xl">‚ö†Ô∏è</div>
          <p class="text-[10px] font-mono text-red-400 uppercase tracking-widest">CCTV SEDANG GANGGUAN</p>
          <p id="error-detail" class="text-[9px] text-slate-500 text-center leading-relaxed"></p>
          <div class="flex gap-2 mt-1">
            <button onclick="app.retryStream()" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 active:bg-blue-700 rounded-lg text-[10px] font-mono uppercase tracking-widest transition-colors">
              ‚Ü∫ Coba Lagi
            </button>
            <button onclick="app.retryWithProxy()" id="proxy-retry-btn" class="px-3 py-2 bg-amber-600 hover:bg-amber-500 active:bg-amber-700 rounded-lg text-[10px] font-mono uppercase tracking-widest transition-colors">
              üîÄ Coba via Proxy
            </button>
          </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black via-black/70 to-transparent z-10 pointer-events-none">
          <h2 id="display-title" class="text-xs font-bold text-blue-400">STANDBY</h2>
          <p id="display-sub" class="text-[11px] text-slate-400 mt-1 uppercase tracking-widest truncate">Silahkan Pilih Ruas Jalan</p>
        </div>

        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 active:opacity-100 transition-opacity pointer-events-none z-20">
          <button onclick="app.toggleFS()" class="pointer-events-auto p-3 bg-white/10 backdrop-blur-xl border border-white/20 rounded-full hover:scale-110 active:scale-95 transition-transform shadow-2xl">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" stroke-width="2" />
            </svg>
          </button>
        </div>

        <div id="loader" class="absolute inset-0 flex items-center justify-center bg-slate-900/90 hidden z-40">
          <div class="flex flex-col items-center gap-3">
            <div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <span class="text-[9px] font-mono tracking-[0.3em] text-blue-400">sedang menghubungkan</span>
          </div>
        </div>
      </div>

    </section>

    <aside class="w-full md:w-96 bg-slate-900/40 flex flex-col overflow-hidden border-l border-slate-900 min-h-0 flex-1 md:flex-none">
      <div class="p-4 bg-slate-900/80 border-b border-slate-800 backdrop-blur-sm flex-shrink-0">
        <input type="text" id="cctv-search" placeholder="Cari ruas jalan..." autocomplete="off" autocorrect="off" spellcheck="false" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-[14px] focus:ring-1 focus:ring-blue-500 outline-none transition-all placeholder:text-slate-600">
      </div>
      <div id="menu-container" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-3 overscroll-contain"></div>
    </aside>
  </main>

  <script>
    // ============================================================
    // URL Cloudflare Worker milik Anda
    // ============================================================
    const CORS_PROXY_URL = 'https://cctv.sdedyatm.workers.dev/?url=';
    const categories = [{
        id: 'kawasan',
        name: 'KAWASAN BIC',
        icon: 'üöõ',
        subs: [{
            name: 'ISL',
            url: '#'
          },
          {
            name: 'FURUKAWA',
            url: '#'
          },
          {
            name: 'SARI ROTI',
            url: '#'
          },
          {
            name: 'INDOMARCO',
            url: '#'
          },
          {
            name: 'HINO HMMI',
            url: '#'
          }
        ]
      },
      {
        id: 'cikampek',
        name: 'CIKAMPEK',
        icon: 'üü†',
        subs: [{
            name: 'CIKOPO',
            url: 'https://jmlive.jasamarga.com/hls/5/ed6734ac-1cde-4afd-acf9-2658f8e7a254/index.m3u8'
          },
          {
            name: 'Cakung Bks',
            url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-05/index.m3u8'
          },
          {
            name: 'Klari Krwg',
            url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-09/index.m3u8'
          },
          {
            name: 'Simpang Dawuan',
            url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-10/index.m3u8'
          },
          {
            name: 'Tambun',
            url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-01/index.m3u8'
          },
          {
            name: 'Jl baru krw',
            url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-08/index.m3u8'
          }
        ]
      },
      {
        id: 'bandung',
        name: 'BANDUNG',
        icon: 'üèôÔ∏è',
        subs: [{
            name: 'Pasteur',
            url: 'https://cctv.jasamarga.com/hls/pasteur.m3u8'
          },
          {
            name: 'Cipularang km 96',
            url: 'https://jmlive.jasamarga.com/hls/7/a857b0b5-6fa7-47c7-b129-18290748c7fe/index.m3u8'
          },
          {
            name: 'Cileunyi km 154',
            url: 'https://jmlive.jasamarga.com/hls/6/43eaa44d-5bbf-4dd3-bffa-3d2981d4517a/index.m3u8'
          },
          {
            name: 'Gedebage',
            url: 'https://cctv.jasamarga.com/hls/gedebage.m3u8'
          },
          {
            name: 'ss Buah Batu',
            url: 'https://jmlive.jasamarga.com/hls/6/53a1c95b-8d71-45e8-874f-9d96d9be3c23/index.m3u8'
          }
        ]
      },
      {
        id: 'japek',
        name: 'TOL JAPEK',
        icon: 'üìç',
        subs: [{
            name: 'KM 10 Cikunir',
            url: 'https://cctv.jasamarga.com/hls/km10.m3u8'
          },
          {
            name: 'KM 21 Tambun',
            url: 'https://cctv.jasamarga.com/hls/km21.m3u8'
          },
          {
            name: 'KM 31 Cikarang',
            url: 'https://cctv.jasamarga.com/hls/km31.m3u8'
          },
          {
            name: 'KM 47 Karawang',
            url: 'https://cctv.jasamarga.com/hls/km47.m3u8'
          },
          {
            name: 'Layang MBZ',
            url: 'https://cctv.jasamarga.com/hls/mbz.m3u8'
          }
        ]
      },
      {
        id: 'tangmer',
        name: 'TOL TANGERANG MERAK',
        icon: 'üöö',
        subs: [{
            name: 'Bitung',
            url: 'https://cctv.astratol.co.id/hls/bitung.m3u8'
          },
          {
            name: 'Balaraja Barat',
            url: 'https://cctv.mms-corp.id/balbar-exit/index.m3u8'
          },
          {
            name: 'Exit Merak',
            url: 'https://cctv.mms-corp.id/merak-exit/index.m3u8'
          },
          {
            name: 'Serang Timur',
            url: 'https://cctv.astratol.co.id/hls/serang.m3u8'
          },
          {
            name: 'Cilegon Timur',
            url: 'https://cctv.mms-corp.id/ciltim-entrance/index.m3u8'
          }
        ]
      },
      {
        id: 'merak',
        name: 'MERAK',
        icon: 'üö¢',
        subs: [{
            name: 'Dermaga Eksekutif',
            url: 'https://stream.asdp.id/hls/merak-eksekutif.m3u8'
          },
          {
            name: 'Dermaga 1',
            url: 'https://stream.asdp.id/hls/merak1.m3u8'
          },
          {
            name: 'Dermaga 2',
            url: 'https://stream.asdp.id/hls/merak2.m3u8'
          },
          {
            name: 'Pintu Masuk Port',
            url: 'https://stream.asdp.id/hls/gate-merak.m3u8'
          },
          {
            name: 'Area Parkir',
            url: 'https://stream.asdp.id/hls/parkir-merak.m3u8'
          }
        ]
      },
      {
        id: 'bojonegara',
        name: 'BOJONEGARA',
        icon: '‚öì',
        subs: [{
            name: 'Gate Utama',
            url: 'https://cctv.pelindo.co.id/bojonegara1.m3u8'
          },
          {
            name: 'Area Logistik',
            url: 'https://cctv.pelindo.co.id/bojonegara2.m3u8'
          },
          {
            name: 'Dermaga',
            url: 'https://cctv.pelindo.co.id/bojonegara3.m3u8'
          },
          {
            name: 'Jalur Akses',
            url: 'https://cctv.pelindo.co.id/bojonegara4.m3u8'
          },
          {
            name: 'Pergudangan',
            url: 'https://cctv.pelindo.co.id/bojonegara5.m3u8'
          }
        ]
      },
      {
        id: 'indramayu',
        name: 'INDRAMAYU',
        icon: 'üåæ',
        subs: [{
            name: 'Pantura Lohbener',
            url: 'https://dishub.indramayukab.go.id/lohbener.m3u8'
          },
          {
            name: 'Jatibarang',
            url: 'https://dishub.indramayukab.go.id/jatibarang.m3u8'
          },
          {
            name: 'Karangampel',
            url: 'https://dishub.indramayukab.go.id/karangampel.m3u8'
          },
          {
            name: 'Eretan',
            url: 'https://dishub.indramayukab.go.id/eretan.m3u8'
          },
          {
            name: 'Losarang',
            url: 'https://dishub.indramayukab.go.id/losarang.m3u8'
          }
        ]
      },
      {
        id: 'cirebon',
        name: 'CIREBON',
        icon: 'üèØ',
        subs: [{
            name: 'Plumbon',
            url: 'https://cctv.jasamarga.com/hls/plumbon.m3u8'
          },
          {
            name: 'Kanci',
            url: 'https://cctv.jasamarga.com/hls/kanci.m3u8'
          },
          {
            name: 'Palimanan',
            url: 'https://cctv.jasamarga.com/hls/palimanan.m3u8'
          },
          {
            name: 'Plered',
            url: 'https://dishub.cirebonkota.go.id/plered.m3u8'
          },
          {
            name: 'Harjamukti',
            url: 'https://dishub.cirebonkota.go.id/harjamukti.m3u8'
          }
        ]
      },
      {
        id: 'semarang',
        name: 'SEMARANG',
        icon: 'üèõÔ∏è',
        subs: [{
            name: 'Simpang Lima',
            url: 'https://cctv.semarangkota.go.id/simpang5.m3u8'
          },
          {
            name: 'Kaligawe',
            url: 'https://cctv.semarangkota.go.id/kaligawe.m3u8'
          },
          {
            name: 'Krapyak',
            url: 'https://cctv.jasamarga.com/hls/krapyak.m3u8'
          },
          {
            name: 'Jatingaleh',
            url: 'https://cctv.jasamarga.com/hls/jatingaleh.m3u8'
          },
          {
            name: 'Banyumanik',
            url: 'https://cctv.jasamarga.com/hls/banyumanik.m3u8'
          }
        ]
      },
      {
        id: 'surabaya',
        name: 'SURABAYA',
        icon: 'ü¶à',
        subs: [{
            name: 'Waru',
            url: 'https://cctv.jasamarga.com/hls/waru.m3u8'
          },
          {
            name: 'Gunung Sari',
            url: 'https://cctv.jasamarga.com/hls/gunungsari.m3u8'
          },
          {
            name: 'Dupak',
            url: 'https://cctv.jasamarga.com/hls/dupak.m3u8'
          },
          {
            name: 'Suramadu',
            url: 'https://dishub.surabaya.go.id/suramadu.m3u8'
          },
          {
            name: 'Perak',
            url: 'https://dishub.surabaya.go.id/perak.m3u8'
          }
        ]
      },
      {
        id: 'lampung',
        name: 'LAMPUNG',
        icon: 'üêò',
        subs: [{
            name: 'Bakauheni Port',
            url: 'https://stream.asdp.id/hls/bakauheni.m3u8'
          },
          {
            name: 'Kalianda',
            url: 'https://cctv.tol-lampung.com/v1/kalianda.m3u8'
          },
          {
            name: 'Terbanggi Besar',
            url: 'https://cctv.tol-lampung.com/v1/terbanggi.m3u8'
          },
          {
            name: 'Tegineneng',
            url: 'https://cctv.tol-lampung.com/v1/tegineneng.m3u8'
          },
          {
            name: 'Mesuji',
            url: 'https://cctv.tol-lampung.com/v1/mesuji.m3u8'
          }
        ]
      },
      {
        id: 'palembang',
        name: 'PALEMBANG',
        icon: 'üåâ',
        subs: [{
            name: 'Ampera',
            url: 'https://dishub.palembang.go.id/ampera.m3u8'
          },
          {
            name: 'Jakabaring',
            url: 'https://dishub.palembang.go.id/jakabaring.m3u8'
          },
          {
            name: 'KM 12',
            url: 'https://cctv.hutamakarya.com/palembang12.m3u8'
          },
          {
            name: 'Kramasan',
            url: 'https://cctv.hutamakarya.com/kramasan.m3u8'
          },
          {
            name: 'Indralaya',
            url: 'https://cctv.hutamakarya.com/indralaya.m3u8'
          }
        ]
      },
      {
        id: 'jambi',
        name: 'JAMBI',
        icon: 'üîµ',
        subs: [{
            name: 'Simpang Rimbo',
            url: 'https://dishub.jambikota.go.id/rimbo.m3u8'
          },
          {
            name: 'Aur Duri',
            url: 'https://dishub.jambikota.go.id/aurduri.m3u8'
          },
          {
            name: 'Muara Bulian',
            url: 'https://dishub.jambikota.go.id/bulian.m3u8'
          },
          {
            name: 'Tugu Juang',
            url: 'https://dishub.jambikota.go.id/juang.m3u8'
          },
          {
            name: 'Sipin',
            url: 'https://dishub.jambikota.go.id/sipin.m3u8'
          }
        ]
      },
       {
        id: 'padang',
        name: 'PADANG',
        icon: 'üü¢',
        subs: [{
            name: 'padang',
            url: '#'
          },
          {
            name: 'SITINJAU',
            url: '#'
          },
          {
            name: 'GUNUNG MEDAN',
            url: '#'
          },
          {
            name: 'JAMBI',
            url: '#'
          },
          {
            name: 'JEMBATAN',
            url: '#'
          }
        ]
      },                 
      {
        id: 'pekanbaru',
        name: 'PEKANBARU',
        icon: 'üü°',
        subs: [{
            name: 'Simpang Bingung',
            url: 'https://dishub.pekanbaru.go.id/bingung.m3u8'
          },
          {
            name: 'Panam',
            url: 'https://dishub.pekanbaru.go.id/panam.m3u8'
          },
          {
            name: 'Rumbai',
            url: 'https://dishub.pekanbaru.go.id/rumbai.m3u8'
          },
          {
            name: 'Tol Permai',
            url: 'https://cctv.hutamakarya.com/permai.m3u8'
          },
          {
            name: 'Arengka',
            url: 'https://dishub.pekanbaru.go.id/arengka.m3u8'
          }
        ]
      },
      {
        id: 'medan',
        name: 'MEDAN',
        icon: 'üåé',
        subs: [{
            name: 'Amplas',
            url: 'https://atcs.medan.id/hls/amplas.m3u8'
          },
          {
            name: 'Belawan',
            url: 'https://cctv.jasamarga.com/hls/belawan.m3u8'
          },
          {
            name: 'GT TJ Morawa',
            url: 'https://jmlive.jasamarga.com/hls/24/a4776165-5356-4edf-ac12-2a1f1fc0fb00/index.m3u8'
          },
          {
            name: 'Maimun',
            url: 'https://atcs.medan.id/hls/maimun.m3u8'
          },
          {
            name: 'Simpang Pos',
            url: 'https://atcs.medan.id/hls/simpangpos.m3u8'
          }
        ]
      }
    ];
    class TrafficApp {
      constructor() {
        this.video = document.getElementById('main-video');
        this.loader = document.getElementById('loader');
        this.errorOverlay = document.getElementById('error-overlay');
        this.playOverlay = document.getElementById('play-overlay');
        this.hls = null;
        this.currentUrl = null;
        this.currentCat = null;
        this.currentSub = null;
        this.fatalErrorCount = 0;
        this.autoplayBlocked = false;
        this.isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
        this.isAndroid = /Android/i.test(navigator.userAgent);
        // Proxy default ON di mobile, OFF di desktop
        this.proxyEnabled = this.isMobile;
        this.init();
      }
      init() {
        this.renderMenu();
        this.setupSearch();
        this.setupVideoEvents();
        this.updateProxyUI();
        document.getElementById('status-bar').innerText = 'CCTV MUDIK 2026';
        if (this.isAndroid) {
          document.getElementById('info-box-text').innerHTML =
            'üì± Android terdeteksi ‚Äî PROXY otomatis aktif via <strong>cctv.sdedyatm.workers.dev</strong>. Pilih channel untuk streaming.';
        }
      }
      // Bungkus URL dengan proxy jika mode proxy aktif
      wrapUrl(url) {
        if (!this.proxyEnabled || !url || url === '#') return url;
        return CORS_PROXY_URL + encodeURIComponent(url);
      }
      toggleProxy() {
        this.proxyEnabled = !this.proxyEnabled;
        this.updateProxyUI();
        if (this.currentUrl) this.retryStream();
      }
      updateProxyUI() {
        const label = document.getElementById('proxy-status-label');
        const btn = document.getElementById('proxy-toggle-btn');
        const banner = document.getElementById('proxy-banner');
        if (this.proxyEnabled) {
          label.textContent = 'ON';
          btn.classList.remove('border-slate-700', 'text-slate-500');
          btn.classList.add('border-green-600', 'text-green-400', 'bg-green-900/20');
          banner.style.display = 'block';
        } else {
          label.textContent = 'OFF';
          btn.classList.add('border-slate-700', 'text-slate-500');
          btn.classList.remove('border-green-600', 'text-green-400', 'bg-green-900/20');
          banner.style.display = 'none';
        }
      }
      setupVideoEvents() {
        // Auto-resume jika video stall
        this.video.addEventListener('stalled', () => {
          setTimeout(() => {
            if (!this.video.paused && this.video.readyState < 3) {
              this.video.load();
              this.video.play().catch(() => {});
            }
          }, 3000);
        });
        // Resume jika pause tidak disengaja
        this.video.addEventListener('pause', () => {
          if (!this.autoplayBlocked && this.currentUrl && !this.video.ended) {
            setTimeout(() => {
              if (this.video.paused && this.currentUrl && !this.autoplayBlocked) {
                this.video.play().catch(() => {});
              }
            }, 500);
          }
        });
      }
      renderMenu() {
        const container = document.getElementById('menu-container');
        container.innerHTML = categories.map(cat => `
          <div class="category-group">
            <button onclick="app.toggleSub('${cat.id}')"
              class="w-full p-4 bg-slate-800/40 border border-slate-800 rounded-2xl flex items-center justify-between hover:bg-slate-800 hover:border-blue-500/30 active:bg-slate-700 transition-all group">
              <span class="font-bold text-[16px] tracking-widest flex items-center gap-3">
                <span class="text-lg opacity-80">${cat.icon}</span>
                ${cat.name}
              </span>
              <svg class="w-4 h-4 text-slate-600 group-hover:text-blue-400 transition-transform duration-300 flex-shrink-0"
                id="icon-${cat.id}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="sub-${cat.id}" class="submenu-container grid grid-cols-1 gap-1.5">
              ${cat.subs.map(sub => `
                <button onclick="app.play('${cat.name}', '${sub.name}', '${sub.url}', this)"
                  class="p-3 bg-slate-900/60 border border-slate-800/50 rounded-xl text-[15px] text-left
                         hover:border-blue-500/50 hover:text-blue-400 active:bg-slate-800 transition-all
                         font-mono uppercase pl-6 relative overflow-hidden group">
                  <span class="absolute left-2 top-1/2 -translate-y-1/2 w-1 h-1 bg-slate-700 rounded-full group-hover:bg-blue-500 transition-colors"></span>
                  ${sub.name}
                </button>
              `).join('')}
            </div>
          </div>
        `).join('');
      }
      toggleSub(id) {
        const el = document.getElementById(`sub-${id}`);
        const icon = document.getElementById(`icon-${id}`);
        const isOpen = el.classList.contains('open');
        document.querySelectorAll('.submenu-container').forEach(m => m.classList.remove('open'));
        document.querySelectorAll('svg[id^="icon-"]').forEach(i => i.style.transform = 'rotate(0deg)');
        if (!isOpen) {
          el.classList.add('open');
          icon.style.transform = 'rotate(180deg)';
        }
      }
      showLoader() {
        this.loader.classList.remove('hidden');
        this.errorOverlay.style.display = 'none';
        this.playOverlay.style.display = 'none';
      }
      hideLoader() {
        this.loader.classList.add('hidden');
      }
      showError(msg) {
        this.hideLoader();
        this.playOverlay.style.display = 'none';
        this.errorOverlay.style.display = 'flex';
        document.getElementById('error-detail').innerText = msg || 'Stream tidak dapat dimuat.';
        // Sembunyikan tombol proxy-retry jika proxy sudah aktif
        document.getElementById('proxy-retry-btn').style.display = this.proxyEnabled ? 'none' : 'inline-flex';
      }
      showPlayButton() {
        this.hideLoader();
        this.errorOverlay.style.display = 'none';
        this.playOverlay.style.display = 'flex';
        this.autoplayBlocked = true;
      }
      manualPlay() {
        this.playOverlay.style.display = 'none';
        this.autoplayBlocked = false;
        this.video.play().catch(() => {
          if (this.currentUrl) this.retryStream();
        });
      }
      destroyHls() {
        if (this.hls) {
          this.hls.destroy();
          this.hls = null;
        }
        this.video.pause();
        this.video.removeAttribute('src');
        this.video.load();
        this.autoplayBlocked = false;
      }
      play(cat, sub, url, btn) {
        if (!url || url === '#') {
          this.showError('Stream untuk channel ini belum tersedia.');
          return;
        }
        this.currentUrl = url; // simpan URL asli, bukan yang sudah di-wrap
        this.currentCat = cat;
        this.currentSub = sub;
        this.fatalErrorCount = 0;
        this.showLoader();
        document.querySelectorAll('.submenu-container button').forEach(b => b.classList.remove('active-btn'));
        btn.classList.add('active-btn');
        document.getElementById('display-title').innerText = `${cat} ‚Äî ${sub}`;
        document.getElementById('display-sub').innerText =
          `Syncing${this.proxyEnabled ? ' [PROXY]' : ''}: ${url.split('/').pop()}`;
        this.destroyHls();
        this.startStream(url);
      }
      startStream(originalUrl) {
        const streamUrl = this.wrapUrl(originalUrl);
        if (Hls.isSupported()) {
          this.loadWithHls(streamUrl);
        } else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
          this.loadNative(streamUrl);
        } else {
          this.showError('Browser tidak mendukung HLS playback.');
        }
      }
      loadWithHls(streamUrl) {
        const hlsConfig = {
          enableWorker: !this.isMobile,
          lowLatencyMode: false,
          backBufferLength: this.isMobile ? 10 : 30,
          maxBufferLength: this.isMobile ? 15 : 30,
          maxMaxBufferLength: this.isMobile ? 30 : 60,
          maxBufferSize: this.isMobile ? 10 * 1000 * 1000 : 20 * 1000 * 1000,
          maxBufferHole: 0.5,
          startFragPrefetch: false,
          testBandwidth: false,
          xhrSetup: (xhr) => {
            xhr.withCredentials = false;
          },
          manifestLoadingTimeOut: this.isMobile ? 10000 : 15000,
          manifestLoadingMaxRetry: 2,
          manifestLoadingRetryDelay: 1000,
          levelLoadingTimeOut: this.isMobile ? 10000 : 15000,
          levelLoadingMaxRetry: 2,
          fragLoadingTimeOut: this.isMobile ? 15000 : 20000,
          fragLoadingMaxRetry: 3,
          fragLoadingRetryDelay: 1000,
          debug: false,
        };
        const hls = new Hls(hlsConfig);
        this.hls = hls;
        hls.loadSource(streamUrl);
        hls.attachMedia(this.video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          this.hideLoader();
          const p = this.video.play();
          if (p !== undefined) {
            p.then(() => {
              this.playOverlay.style.display = 'none';
            }).catch(err => {
              console.warn('Autoplay blocked:', err.name);
              this.showPlayButton();
            });
          }
        });
        hls.on(Hls.Events.ERROR, (event, data) => {
          if (!data.fatal) return;
          this.fatalErrorCount++;
          if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
            if (this.fatalErrorCount <= 2) {
              setTimeout(() => hls.startLoad(), 1000);
            } else {
              const tip = this.proxyEnabled ?
                'Proxy aktif tapi stream tetap gagal.\nServer mungkin sedang offline.' :
                'Aktifkan PROXY (kanan atas) lalu pilih ulang channel.';
              this.showError(`Network Error: ${data.details}\n${tip}`);
              hls.destroy();
            }
          } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
            if (this.fatalErrorCount <= 2) {
              hls.recoverMediaError();
            } else {
              this.showError('Media Error: Format video tidak kompatibel.');
              hls.destroy();
            }
          } else {
            this.showError(`Fatal Error: ${data.details}`);
            hls.destroy();
          }
        });
      }
      loadNative(streamUrl) {
        this.video.src = streamUrl;
        this.video.load();
        this.video.addEventListener('loadedmetadata', () => {
          this.hideLoader();
          this.video.play().catch(() => this.showPlayButton());
        }, {
          once: true
        });
        this.video.addEventListener('error', () => {
          this.showError('Playback error. Stream offline atau CORS diblokir.');
        }, {
          once: true
        });
        const tid = setTimeout(() => {
          if (!this.loader.classList.contains('hidden')) {
            this.showError('Timeout: Stream tidak merespons dalam 15 detik.');
          }
        }, 15000);
        this.video.addEventListener('loadedmetadata', () => clearTimeout(tid), {
          once: true
        });
      }
      retryStream() {
        if (!this.currentUrl || this.currentUrl === '#') return;
        this.showLoader();
        this.fatalErrorCount = 0;
        this.autoplayBlocked = false;
        this.destroyHls();
        setTimeout(() => this.startStream(this.currentUrl), 800);
      }
      // Aktifkan proxy lalu langsung retry
      retryWithProxy() {
        this.proxyEnabled = true;
        this.updateProxyUI();
        this.retryStream();
      }
      setupSearch() {
        document.getElementById('cctv-search').addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase().trim();
          document.querySelectorAll('.category-group').forEach(group => {
            group.style.display = (!term || group.innerText.toLowerCase().includes(term)) ? 'block' : 'none';
          });
        });
      }
      toggleFS() {
        const target = this.isMobile ? this.video : document.getElementById('video-box');
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
          const req = target.requestFullscreen || target.webkitRequestFullscreen;
          if (req) req.call(target).catch(() => {
            if (this.video.requestFullscreen) this.video.requestFullscreen().catch(() => {});
          });
        } else {
          const exit = document.exitFullscreen || document.webkitExitFullscreen;
          if (exit) exit.call(document);
        }
      }
    }
    const app = new TrafficApp();
  </script>

</body>

</html>
