<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>CCTV Traffic Pro Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.13/dist/hls.light.min.js"></script>

  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      overscroll-behavior: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* VIDEO */
    .video-wrapper {
      position: relative;
      width: 55%;
      aspect-ratio: 16/9;
      max-height: 320px;
      background: linear-gradient(145deg, #0a0f1a 0%, #020617 100%);
      border-radius: 20px;
      overflow: hidden;
      box-shadow:
        0 25px 50px -12px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(255, 255, 255, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(71, 85, 105, 0.3);
    }

    #main-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: #000;
      transition: filter 0.3s ease;
    }

    /* HD ENHANCEMENT MODE */
    #main-video.hd-enhanced {
      filter: contrast(1.1) brightness(1.05) saturate(1.1);
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }

    /* SCROLLBAR */
    .custom-scroll {
      scrollbar-width: thin;
      scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

    .custom-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scroll::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 10px;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(59, 130, 246, 0.4) 0%, rgba(59, 130, 246, 0.2) 100%);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }

    .custom-scroll::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, rgba(59, 130, 246, 0.6) 0%, rgba(59, 130, 246, 0.4) 100%);
      background-clip: padding-box;
    }

    /* SUBMENU ACCORDION */
    .submenu-container {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition:
        max-height 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94),
        opacity 0.35s ease-out,
        margin 0.4s ease-out,
        transform 0.35s ease-out;
      transform: translateY(-8px);
    }

    .submenu-container.open {
      max-height: 6000px;
      opacity: 1;
      margin-top: 0.75rem;
      margin-bottom: 0.5rem;
      transform: translateY(0);
    }

    /* TOMBOL KATEGORI */
    .category-btn {
      width: 100%;
      padding: 18px 20px;
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.5) 100%);
      border: 1px solid rgba(71, 85, 105, 0.35);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      min-height: 68px;
      text-align: left;
      -webkit-appearance: none;
      appearance: none;
      outline: none;
      position: relative;
      overflow: hidden;
      transition:
        background 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        border-color 0.3s ease,
        box-shadow 0.3s ease,
        transform 0.2s ease;
    }

    .category-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(145deg, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .category-btn:hover {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.85) 0%, rgba(15, 23, 42, 0.75) 100%);
      border-color: rgba(100, 116, 139, 0.5);
      box-shadow:
        0 8px 25px -5px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(59, 130, 246, 0.1);
    }

    .category-btn:hover::before {
      opacity: 1;
    }

    .category-btn:active {
      transform: scale(0.98);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.9) 0%, rgba(10, 15, 30, 0.85) 100%);
    }

    .category-btn.is-open {
      border-color: rgba(59, 130, 246, 0.6);
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.8) 0%, rgba(59, 130, 246, 0.15) 100%);
      box-shadow:
        0 0 30px rgba(59, 130, 246, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .cat-label {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 12px;
      pointer-events: none;
      color: #f1f5f9;
    }

    .cat-icon {
      font-size: 22px;
      pointer-events: none;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .chevron-icon {
      width: 20px;
      height: 20px;
      color: #94a3b8;
      flex-shrink: 0;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s ease;
      pointer-events: none;
    }

    .category-btn.is-open .chevron-icon {
      transform: rotate(180deg);
      color: #60a5fa;
    }

    /* TOMBOL SUB-MENU */
    .sub-btn {
      width: 100%;
      padding: 16px 16px 16px 28px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.6) 0%, rgba(10, 18, 35, 0.5) 100%);
      border: 1px solid rgba(51, 65, 85, 0.35);
      border-radius: 12px;
      text-align: left;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #e2e8f0;
      min-height: 56px;
      position: relative;
      -webkit-appearance: none;
      appearance: none;
      outline: none;
      overflow: hidden;
      transition:
        background 0.25s ease,
        border-color 0.25s ease,
        color 0.25s ease,
        box-shadow 0.25s ease,
        transform 0.15s ease;
    }

    .sub-btn::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(100, 116, 139, 0.6);
      transition: background 0.25s ease, box-shadow 0.25s ease;
      pointer-events: none;
    }

    .sub-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, transparent 60%);
      opacity: 0;
      transition: opacity 0.25s ease;
      pointer-events: none;
    }

    .sub-btn:hover {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(59, 130, 246, 0.12) 100%);
      border-color: rgba(59, 130, 246, 0.4);
      color: #93c5fd;
      box-shadow:
        0 4px 15px rgba(0, 0, 0, 0.3),
        0 0 20px rgba(59, 130, 246, 0.1);
    }

    .sub-btn:hover::before {
      background: #3b82f6;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
    }

    .sub-btn:hover::after {
      opacity: 1;
    }

    .sub-btn:active {
      transform: scale(0.98);
    }

    .sub-btn.active-btn {
      border-left: 4px solid #3b82f6;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(30, 64, 175, 0.15) 100%);
      color: #60a5fa;
      box-shadow:
        0 0 25px rgba(59, 130, 246, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .sub-btn.active-btn::before {
      background: #3b82f6;
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.8);
    }

    /* OVERLAYS */
    .overlay {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      z-index: 50;
    }

    .overlay.show {
      display: flex;
    }

    /* PULSE DOT */
    @keyframes pulse-green {

      0%,
      100% {
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
      }

      50% {
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.9), 0 0 30px rgba(34, 197, 94, 0.5);
      }
    }

    #connection-dot {
      animation: pulse-green 2.5s infinite;
    }

    /* SPINNER */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .spinner {
      animation: spin 0.85s linear infinite;
    }

    /* HEADER */
    .header-container {
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.98) 0%, rgba(15, 23, 42, 0.95) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    /* SEARCH INPUT */
    .search-input {
      background: linear-gradient(145deg, rgba(10, 15, 30, 0.8) 0%, rgba(5, 10, 20, 0.6) 100%);
      border: 1px solid rgba(71, 85, 105, 0.3);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .search-input:focus {
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.15);
    }

    /* SIDEBAR */
    .sidebar-container {
      background: linear-gradient(180deg, rgba(10, 18, 35, 0.5) 0%, rgba(5, 12, 25, 0.4) 100%);
    }

    /* VIDEO SECTION */
    .video-section {
      background: linear-gradient(145deg, #020617 0%, #0a0f1a 50%, #020617 100%);
    }

    /* MENU CONTAINER */
    #menu-container {
      scroll-padding-top: 20px;
      overscroll-behavior: contain;
    }

    /* CATEGORY GROUP */
    .category-group {
      margin-bottom: 0.5rem;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       RECORDING HUD TIMER - COMPACT
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .recording-hud {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 40;
      display: none;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      border-radius: 8px;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .recording-hud.active {
      display: flex;
    }

    .rec-dot {
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      animation: rec-pulse 1s infinite;
    }

    @keyframes rec-pulse {

      0%,
      100% {
        opacity: 1;
        box-shadow: 0 0 5px #ef4444, 0 0 10px #ef4444;
      }

      50% {
        opacity: 0.5;
        box-shadow: 0 0 2px #ef4444;
      }
    }

    .rec-timer {
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
      font-weight: 600;
      color: #ef4444;
      text-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
      letter-spacing: 0.03em;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       RECORDING CONTROL PANEL - OUTSIDE VIDEO
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .recording-panel {
      width: 100%;
      max-width: 600px;
      margin-top: 12px;
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 14px;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.9) 0%, rgba(10, 15, 30, 0.95) 100%);
      border-radius: 16px;
      border: 1px solid rgba(71, 85, 105, 0.35);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .recording-panel.visible {
      display: flex;
    }

    .recording-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(71, 85, 105, 0.25);
    }

    .recording-panel-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .recording-panel-title svg {
      width: 16px;
      height: 16px;
      color: #ef4444;
    }

    /* MAIN RECORD BUTTON - PROMINENT */
    .main-rec-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 24px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .main-rec-btn.start {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
    }

    .main-rec-btn.start:hover {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 6px 25px rgba(220, 38, 38, 0.5);
      transform: translateY(-1px);
    }

    .main-rec-btn.stop {
      background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
      color: white;
      box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
      animation: rec-btn-glow 1.5s infinite;
    }

    @keyframes rec-btn-glow {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
      }

      50% {
        box-shadow: 0 0 35px rgba(239, 68, 68, 0.8), 0 0 50px rgba(239, 68, 68, 0.3);
      }
    }

    .main-rec-btn:active {
      transform: scale(0.97);
    }

    .main-rec-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Recording Options Row */
    .rec-options-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .rec-option-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(10, 15, 30, 0.5);
      border-radius: 10px;
      border: 1px solid rgba(51, 65, 85, 0.3);
      flex: 1;
      min-width: fit-content;
    }

    .rec-option-label {
      font-size: 10px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .rec-select {
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 500;
      color: #e2e8f0;
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
      border: 1px solid rgba(71, 85, 105, 0.4);
      border-radius: 8px;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s ease;
      min-width: 100px;
    }

    .rec-select:hover {
      border-color: rgba(100, 116, 139, 0.6);
    }

    .rec-select:focus {
      border-color: rgba(239, 68, 68, 0.5);
    }

    /* HD Enhancement Button */
    .hd-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 14px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-radius: 8px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      border-color: rgba(96, 165, 250, 0.3);
    }

    .hd-btn:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
    }

    .hd-btn.active {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    /* Sharpness Slider */
    .sharpness-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sharpness-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 70px;
      height: 5px;
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.3) 0%, rgba(59, 130, 246, 0.6) 100%);
      border-radius: 3px;
      cursor: pointer;
      outline: none;
    }

    .sharpness-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
      cursor: pointer;
    }

    .sharpness-slider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      cursor: pointer;
    }

    .sharpness-value {
      font-size: 10px;
      font-family: 'SF Mono', monospace;
      color: #60a5fa;
      min-width: 26px;
      text-align: center;
    }

    /* Status Row */
    .status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 8px;
      border-top: 1px solid rgba(71, 85, 105, 0.2);
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: #64748b;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #475569;
    }

    .status-dot.hd {
      background: #3b82f6;
      box-shadow: 0 0 6px rgba(59, 130, 246, 0.5);
    }

    .status-dot.recording {
      background: #ef4444;
      box-shadow: 0 0 6px rgba(239, 68, 68, 0.5);
      animation: rec-pulse 1s infinite;
    }

    .format-badge {
      font-size: 9px;
      padding: 3px 8px;
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border-radius: 4px;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    /* HIDDEN CANVAS FOR RECORDING */
    #recording-canvas {
      display: none;
    }

    /* TOAST */
    .segment-toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      z-index: 100;
      padding: 12px 20px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(22, 163, 74, 0.95) 100%);
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      white-space: nowrap;
    }

    .segment-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .video-wrapper {
        width: 100%;
        max-height: 260px;
        border-radius: 14px;
      }

      .category-btn {
        padding: 16px 18px;
        min-height: 64px;
      }

      .cat-label {
        font-size: 17px;
        gap: 10px;
      }

      .sub-btn {
        padding: 14px 14px 14px 26px;
        min-height: 54px;
        font-size: 14px;
      }

      #menu-container {
        padding: 12px;
      }

      .recording-panel {
        padding: 12px;
        border-radius: 14px;
      }

      .main-rec-btn {
        padding: 12px 20px;
        font-size: 13px;
      }

      .rec-option-group {
        padding: 6px 10px;
      }

      .rec-select {
        padding: 7px 10px;
        font-size: 11px;
        min-width: 85px;
      }

      .rec-options-row {
        flex-direction: column;
        align-items: stretch;
      }
    }

    @media (max-width: 480px) {
      .video-wrapper {
        border-radius: 12px;
        max-height: 220px;
      }

      .category-btn {
        padding: 14px 16px;
        min-height: 60px;
        border-radius: 12px;
      }

      .cat-label {
        font-size: 16px;
      }

      .sub-btn {
        padding: 13px 12px 13px 24px;
        min-height: 52px;
        font-size: 13.5px;
        border-radius: 10px;
      }

      .recording-panel {
        padding: 10px;
        margin-top: 8px;
      }

      .main-rec-btn {
        padding: 11px 16px;
        font-size: 12px;
      }

      .main-rec-btn svg {
        width: 16px;
        height: 16px;
      }

      .rec-timer {
        font-size: 12px;
      }
    }

    /* LANDSCAPE MOBILE */
    @media (max-height: 500px) and (orientation: landscape) {
      .video-wrapper {
        max-height: 180px;
      }

      .recording-panel {
        padding: 8px;
        gap: 6px;
      }

      .rec-options-row {
        flex-direction: row;
      }
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 h-screen flex flex-col overflow-hidden font-sans">

  <!-- HEADER -->
  <header class="header-container px-4 py-3 border-b border-slate-800/50 flex justify-between items-center z-30 flex-shrink-0">
    <div class="flex items-center gap-3">
      <div class="p-2.5 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl shadow-lg shadow-blue-900/40">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="2" />
        </svg>
      </div>
      <div>
        <h1 class="text-base font-black tracking-tight uppercase">CCTV<span class="text-blue-400">ATM</span></h1>
        <p id="status-bar" class="text-[9px] text-slate-400 font-mono tracking-widest uppercase mt-0.5">Initializing...</p>
      </div>
    </div>
    <div id="connection-dot" class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 flex flex-col md:flex-row overflow-hidden min-h-0">

    <!-- VIDEO SECTION -->
    <section class="video-section p-4 md:p-6 flex flex-col items-center md:flex-1 justify-start md:justify-center border-b md:border-b-0 md:border-r border-slate-900/50 flex-shrink-0">
      <div class="video-wrapper group w-full max-w-2xl" id="video-box">

        <!-- Logo -->
        <div class="absolute top-3 right-3 z-30 opacity-20 pointer-events-none">
          <img src="https://lh3.googleusercontent.com/pw/AP1GczM7DIcF6n6QmapKYKmLrjE1jfdzglHj5YotQm27QErAplykPvCq3qZDbhw3qfrzTenf75srCib_6DH_WMZ-9OioIbjLVf8zb9ehkfA6GeGPPTa8wYiNTO4BvdS0VnMemmusXQsUTJB_S1FvKaNr2p3BRA=w600-h600-s-no-gm?authuser=0" class="w-10 h-10 grayscale" alt="Logo">
        </div>

        <video id="main-video" playsinline webkit-playsinline muted preload="none"></video>

        <!-- Recording HUD Timer (Compact - Inside Video) -->
        <div class="recording-hud" id="recording-hud">
          <div class="rec-dot"></div>
          <span class="rec-timer" id="rec-timer">00:00:00</span>
        </div>

        <!-- Play Overlay -->
        <div id="play-overlay" class="overlay bg-slate-900/90 backdrop-blur-md">
          <button id="play-btn" class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center shadow-2xl shadow-blue-900/50 border-2 border-blue-400/30 active:scale-95 transition-all duration-200 hover:shadow-blue-500/40" style="touch-action:manipulation;cursor:pointer">
            <svg class="w-9 h-9 text-white ml-1 pointer-events-none" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z" />
            </svg>
          </button>
          <p class="text-[11px] font-mono text-slate-400 uppercase tracking-widest">Tap untuk mulai</p>
        </div>

        <!-- Error Overlay -->
        <div id="error-overlay" class="overlay bg-slate-900/95 backdrop-blur-md">
          <div class="text-3xl">‚ö†Ô∏è</div>
          <p class="text-[10px] font-mono text-red-400 uppercase tracking-widest">Stream Tidak Tersedia</p>
          <p id="error-detail" class="text-[9px] text-slate-400 text-center px-6 max-w-xs leading-relaxed"></p>
          <button id="retry-btn" class="mt-2 px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 rounded-xl text-[11px] font-mono uppercase tracking-widest transition-all duration-200 shadow-lg shadow-blue-900/30" style="touch-action:manipulation;cursor:pointer">
            ‚Ü∫ Coba Lagi
          </button>
        </div>

        <!-- Loader -->
        <div id="loader" class="overlay bg-slate-900/90 backdrop-blur-sm">
          <div class="spinner w-10 h-10 border-2 border-blue-500 border-t-transparent rounded-full"></div>
          <span class="text-[9px] font-mono tracking-[0.3em] text-blue-400 uppercase">Memuat Stream...</span>
        </div>

        <!-- Info bar -->
        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 via-black/70 to-transparent z-10 pointer-events-none">
          <h2 id="display-title" class="text-sm font-bold text-blue-400 truncate">STANDBY</h2>
          <p id="display-sub" class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest truncate">Silahkan Pilih Ruas Jalan</p>
        </div>

        <!-- Fullscreen -->
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">
          <button id="fs-btn" class="pointer-events-auto p-3.5 bg-white/10 backdrop-blur-xl border border-white/20 rounded-full active:scale-95 transition-all duration-200 shadow-2xl hover:bg-white/20" style="touch-action:manipulation;cursor:pointer">
            <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" stroke-width="2" />
            </svg>
          </button>
        </div>
      </div>

      <!-- RECORDING CONTROL PANEL (OUTSIDE VIDEO) -->
      <div class="recording-panel" id="recording-panel">
        <div class="recording-panel-header">
          <span class="recording-panel-title">
            <svg fill="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="8" />
            </svg>
            Perekam Video
          </span>
          <span class="format-badge" id="format-badge">MP4/H.264</span>
        </div>

        <!-- Main Record Button -->
        <button id="main-rec-btn" class="main-rec-btn start">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="8" />
          </svg>
          <span>MULAI REKAM</span>
        </button>

        <!-- Options Row -->
        <div class="rec-options-row">
          <div class="rec-option-group">
            <span class="rec-option-label">Durasi:</span>
            <select id="segment-duration" class="rec-select">
              <option value="300000">5 Menit</option>
              <option value="900000" selected>15 Menit</option>
              <option value="1800000">30 Menit</option>
              <option value="3600000">1 Jam</option>
            </select>
          </div>

          <div class="rec-option-group">
            <button id="hd-toggle-btn" class="hd-btn">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              <span>HD</span>
            </button>
            <div class="sharpness-control">
              <span class="rec-option-label">Sharp:</span>
              <input type="range" id="sharpness-slider" class="sharpness-slider" min="0" max="3" step="0.5" value="1">
              <span class="sharpness-value" id="sharpness-value">1.0</span>
            </div>
          </div>
        </div>

        <!-- Status Row -->
        <div class="status-row">
          <div class="status-item">
            <span class="status-dot" id="hd-status-dot"></span>
            <span id="hd-status-text">HD OFF</span>
          </div>
          <div class="status-item" id="rec-status-item" style="display:none;">
            <span class="status-dot recording"></span>
            <span style="color:#ef4444;font-weight:600;">RECORDING</span>
          </div>
          <div class="status-item" id="location-display">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span id="location-name">-</span>
          </div>
        </div>
      </div>
    </section>

    <!-- MENU -->
    <aside class="sidebar-container w-full md:w-96 flex flex-col overflow-hidden border-l border-slate-900/50 min-h-0 flex-1 md:flex-none">
      <div class="p-3 bg-slate-900/50 border-b border-slate-800/40 backdrop-blur-md flex-shrink-0">
        <input type="text" id="cctv-search" placeholder="Cari ruas jalan..." autocomplete="off" autocorrect="off" spellcheck="false" class="search-input w-full border rounded-xl px-4 py-3.5 text-[14px] focus:ring-1 focus:ring-blue-500 outline-none placeholder:text-slate-500">
      </div>
      <div id="menu-container" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2 overscroll-contain"></div>
    </aside>
  </main>

  <!-- Hidden Canvas for Recording with Logo Watermark -->
  <canvas id="recording-canvas"></canvas>

  <!-- Hidden Logo Image for Recording -->
  <img id="watermark-logo" src="https://lh3.googleusercontent.com/pw/AP1GczM7DIcF6n6QmapKYKmLrjE1jfdzglHj5YotQm27QErAplykPvCq3qZDbhw3qfrzTenf75srCib_6DH_WMZ-9OioIbjLVf8zb9ehkfA6GeGPPTa8wYiNTO4BvdS0VnMemmusXQsUTJB_S1FvKaNr2p3BRA=w600-h600-s-no-gm?authuser=0" style="display:none;" crossorigin="anonymous">

  <!-- Toast -->
  <div class="segment-toast" id="segment-toast">
    ‚úì Segmen berhasil disimpan!
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const categories = [{
        id: 'kawasan',
        name: 'KAWASAN BIC',
        icon: '‚ùÑÔ∏è',
        subs: [{
            name: 'ISL',
            url: '#'
          }, {
            name: 'FURUKAWA',
            url: '#'
          }, {
            name: 'SARI ROTI',
            url: '#'
          },
          {
            name: 'INDOMARCO',
            url: '#'
          }, {
            name: 'HINO HMMI',
            url: '#'
          }
        ]
      },
      {
        id: 'pantura',
        name: 'PANTURA',
        icon: 'üí´',
        subs: [{
            name: 'CIKOPO',
            url: 'https://jmlive.jasamarga.com/hls/5/0b544bf7-a723-4c39-9010-8662792331fc/index.m3u8'
          },
          {
            name: 'Cakung Bks',
            url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-05/index.m3u8'
          },
          {
            name: 'stasiun Bks',
            url: 'https://eofficev2.bekasikota.go.id/backupcctv/m3/stasiun_bekasi.m3u8'
          },
          {
            name: 'Klari Krwg',
            url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-09/index.m3u8'
          },
          {
            name: 'Simpang Dawuan',
            url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-10/index.m3u8'
          },
          {
            name: 'Tambun',
            url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-01/index.m3u8'
          },
          {
            name: 'Terminal Bekasi',
            url: 'https://eofficev2.bekasikota.go.id/backupcctv/m3/terminal_bekasi.m3u8'
          },
          {
            name: 'Jl baru krw',
            url: 'https://its.binamarga.pu.go.id:8989/play/hls/CT-08/index.m3u8'
          },
          {
            name: 'sasak Sewo',
            url: 'https://streamer.indramayukab.go.id/memfs/4bb80c7d-72d5-47d2-a10e-b4fde7862205.m3u8'
          },
          {
            name: 'Patrol',
            url: 'https://streamer.indramayukab.go.id/memfs/3ac9140a-7c4d-486b-bb05-7bb2e746077c.m3u8'
          },
          {
            name: 'Eretan',
            url: 'https://streamer.indramayukab.go.id/memfs/a0f95576-2417-4863-a2e3-a1ee21865cfc.m3u8'
          },
          {
            name: 'Lohbener',
            url: '#'
          },
          {
            name: 'Jatibarang',
            url: '#'
          },
          {
            name: 'Karangampel',
            url: 'https://streamer.indramayukab.go.id/memfs/4bb48c21-088d-43a5-82f1-2fa495f50408.m3u8'
          },
          {
            name: 'Indramayu',
            url: 'https://streamer.indramayukab.go.id/memfs/8f10960b-3ffd-4dd9-bd2b-01cf7a0d1cc2.m3u8'
          },
          {
            name: 'Balongan',
            url: '#'
          },
          {
            name: 'Arjawinangun',
            url: '#'
          },
          {
            name: 'samping trml cirebon',
            url: 'https://cctv.cirebonkota.go.id/hls/atcs-simpang-terminal/index.m3u8'
          },
          {
            name: 'Palimanan',
            url: '#'
          },
          {
            name: 'Mundu',
            url: '#'
          },
          {
            name: 'Kanci',
            url: '#'
          },
          {
            name: 'Gebang',
            url: '#'
          },
          {
            name: 'Losari',
            url: '#'
          },
          {
            name: 'Brebes',
            url: '#'
          },
          {
            name: 'Tegal',
            url: '#'
          },
          {
            name: 'Pemalang',
            url: '#'
          },
          {
            name: 'Pekalongan',
            url: '#'
          },
          {
            name: 'Semarang',
            url: '#'
          },
          {
            name: 'Demak',
            url: '#'
          },
          {
            name: 'Lasem',
            url: '#'
          },
          {
            name: 'Lamongan',
            url: '#'
          },
          {
            name: 'Surabaya',
            url: '#'
          }
        ]
      }, {
        id: 'selatan',
        name: 'Jalur Selatan',
        icon: 'üü¢',
        subs: [{
            name: 'Sadang Pwk',
            url: 'https://cctv.purwakartakab.go.id/live/cctv_perempatan_sadang/index.m3u8?key=papais-cctv-pwk-2026-xK9mN3pQ'
          },
          {
            name: 'Arah Pwk Cianjur',
            url: 'https://atcs.cianjurkab.go.id:5443/LieApp/streams/SP3-Lewibungur.m3u8'
          },
          {
            name: 'Tg pramuka Cianjur',
            url: 'https://atcs.cianjurkab.go.id:5443/LieApp/streams/qnKKHlS27Pw41759502638300.m3u8'
          },
          {
            name: 'Tg pandanwangi Cianjur',
            url: 'https://atcs.cianjurkab.go.id:5443/LieApp/streams/qnKKHlS27Pw41759502638300.m3u8'
          },
          {
            name: 'Bundaran Gentur Cianjur',
            url: 'https://atcs.cianjurkab.go.id:5443/LieApp/streams/BundaranTuguGentur.m3u8'
          },
          {
            name: 'Jbt Citarum Cianjur',
            url: 'https://atcs.cianjurkab.go.id:5443/LieApp/streams/pjdoCuZQu1Yj1759502012203.m3u8'
          },
          {
            name: 'Wr Kondang Cianjur',
            url: 'https://atcs.cianjurkab.go.id:5443/LieApp/streams/5YK77KVsswMU1762835161499.m3u8'
          },
          {
            name: 'Padalarang',
            url: 'https://cctv.atcs-dishubkbb.id/memfs/8c6a68c4-5fa5-44b6-8be5-72860ba26ba8_output_0.m3u8?session=89RgtGrTHzegmpGsgG8fYa'
          },
          {
            name: 'Padalarang Arah Pwk',
            url: 'https://cctv.atcs-dishubkbb.id/memfs/a103fb59-3c3d-4bf3-b1b1-edc8232fdf48_output_0.m3u8?session=iZrZ22jeZYC7QYvLNJ5tW8'
          },
          {
            name: 'Bandung',
            url: '#'
          },
          {
            name: 'Sumedang',
            url: '#'
          },
          {
            name: 'Majalengka',
            url: '#'
          },
          {
            name: 'Kuningan',
            url: '#'
          },
          {
            name: 'Bogor',
            url: '#'
          },
          {
            name: 'Ciawi',
            url: '#'
          },
          {
            name: 'Sukabumi',
            url: '#'
          },
          {
            name: 'Pelabuhan Ratu',
            url: '#'
          },
          {
            name: 'Bayah',
            url: '#'
          },
          {
            name: 'Malingping',
            url: '#'
          },
          {
            name: 'Cileunyi',
            url: '#'
          },
          {
            name: 'Nangreg',
            url: '#'
          },
          {
            name: 'Garut',
            url: '#'
          },
          {
            name: 'Tasik',
            url: '#'
          },
          {
            name: 'Banjar',
            url: '#'
          },
          {
            name: 'Pangandaran',
            url: '#'
          },
          {
            name: 'Kebumen',
            url: '#'
          },
          {
            name: 'Magelang',
            url: '#'
          }
        ]
      }, {
        id: 'tol',
        name: 'Via Tol',
        icon: 'üîù',
        subs: [{
            name: 'Tol Merak',
            url: 'https://cctv.mms-corp.id/km96-ambon/index.m3u8'
          },
          {
            name: 'Cilegon',
            url: 'https://cctv.mms-corp.id/km29-bandung/index.m3u8'
          },
          {
            name: 'Serang',
            url: 'https://cctv.mms-corp.id/sertim-entrance/stream.m3u8'
          },
          {
            name: 'Balaraja Barat',
            url: 'https://cctv.mms-corp.id/balbar-entrance/index.m3u8'
          },
          {
            name: 'Bitung',
            url: '#'
          },
          {
            name: 'Karawaci',
            url: '#'
          },
          {
            name: 'Kbn Jeruk',
            url: '#'
          },
          {
            name: 'Jor Rambutan',
            url: '#'
          },
          {
            name: 'GT Cikunir',
            url: '#'
          },
          {
            name: 'GT Cikampek',
            url: '#'
          },
          {
            name: 'Cikopo',
            url: '#'
          },
          {
            name: 'Cipali km 84',
            url: '#'
          },
          {
            name: 'Cipali km',
            url: '#'
          },
          {
            name: 'Cisumdawu',
            url: '#'
          },
          {
            name: 'Subang',
            url: '#'
          },
          {
            name: 'Kertajati',
            url: '#'
          },
          {
            name: 'Palimanan',
            url: 'https://jmlive.jasamarga.com/hls/12/bf37d582-7308-45e3-b6d5-7376b3f92553/index.m3u8'
          },
          {
            name: 'Kanci',
            url: 'https://jmlive.jasamarga.com/hls/12/4155887e-1ebf-4fd2-ad4f-ba0e519adf4c/index.m3u8'
          },
          {
            name: 'GT Pejagan',
            url: '#'
          },
          {
            name: 'Brebes Tmr',
            url: 'https://pptrlive.co.id/memfs/3e7878d0-d138-4739-994f-9c1f9a280f2f.m3u8'
          },
          {
            name: 'Batang',
            url: '#'
          },
          {
            name: 'Semarang',
            url: '#'
          },
          {
            name: 'Surabaya',
            url: '#'
          },
          {
            name: 'Malang',
            url: '#'
          },
          {
            name: 'Jogya',
            url: '#'
          }
        ]
      }, {
        id: 'lampung',
        name: 'LAMPUNG',
        icon: 'üü£',
        subs: [{
            name: 'Bakauheni Port',
            url: 'https://stream.asdp.id/hls/bakauheni.m3u8'
          },
          {
            name: 'Kalianda',
            url: 'https://cctv.tol-lampung.com/v1/kalianda.m3u8'
          },
          {
            name: 'Terbanggi Besar',
            url: 'https://cctv.tol-lampung.com/v1/terbanggi.m3u8'
          },
          {
            name: 'Tegineneng',
            url: 'https://cctv.tol-lampung.com/v1/tegineneng.m3u8'
          },
          {
            name: 'Mesuji',
            url: 'https://cctv.tol-lampung.com/v1/mesuji.m3u8'
          }
        ]
      }, {
        id: 'palembang',
        name: 'PALEMBANG',
        icon: 'üü†',
        subs: [{
            name: 'Ampera',
            url: 'https://dishub.palembang.go.id/ampera.m3u8'
          },
          {
            name: 'Jakabaring',
            url: 'https://dishub.palembang.go.id/jakabaring.m3u8'
          },
          {
            name: 'KM 12',
            url: 'https://cctv.hutamakarya.com/palembang12.m3u8'
          },
          {
            name: 'Kramasan',
            url: 'https://cctv.hutamakarya.com/kramasan.m3u8'
          },
          {
            name: 'Indralaya',
            url: 'https://cctv.hutamakarya.com/indralaya.m3u8'
          }
        ]
      }, {
        id: 'jambi',
        name: 'JAMBI',
        icon: 'üî¥',
        subs: [{
            name: 'Simpang Rimbo',
            url: 'https://dishub.jambikota.go.id/rimbo.m3u8'
          },
          {
            name: 'Aur Duri',
            url: 'https://dishub.jambikota.go.id/aurduri.m3u8'
          },
          {
            name: 'Muara Bulian',
            url: 'https://dishub.jambikota.go.id/bulian.m3u8'
          },
          {
            name: 'Tugu Juang',
            url: 'https://dishub.jambikota.go.id/juang.m3u8'
          },
          {
            name: 'Sipin',
            url: 'https://dishub.jambikota.go.id/sipin.m3u8'
          }
        ]
      }, {
        id: 'padang',
        name: 'PADANG',
        icon: 'üü¢',
        subs: [{
            name: 'Simpang Rimbo',
            url: 'https://dishub.jambikota.go.id/rimbo.m3u8'
          },
          {
            name: 'Aur Duri',
            url: 'https://dishub.jambikota.go.id/aurduri.m3u8'
          },
          {
            name: 'Muara Bulian',
            url: 'https://dishub.jambikota.go.id/bulian.m3u8'
          },
          {
            name: 'Tugu Juang',
            url: 'https://dishub.jambikota.go.id/juang.m3u8'
          },
          {
            name: 'Sipin',
            url: 'https://dishub.jambikota.go.id/sipin.m3u8'
          }
        ]
      }, {
        id: 'pekanbaru',
        name: 'PEKANBARU',
        icon: '‚ö™',
        subs: [{
            name: 'Simpang Bingung',
            url: 'https://dishub.pekanbaru.go.id/bingung.m3u8'
          },
          {
            name: 'Panam',
            url: 'https://dishub.pekanbaru.go.id/panam.m3u8'
          },
          {
            name: 'Rumbai',
            url: 'https://dishub.pekanbaru.go.id/rumbai.m3u8'
          },
          {
            name: 'Tol Permai',
            url: 'https://cctv.hutamakarya.com/permai.m3u8'
          },
          {
            name: 'Arengka',
            url: 'https://dishub.pekanbaru.go.id/arengka.m3u8'
          }
        ]
      }, {
        id: 'medan',
        name: 'MEDAN',
        icon: 'üîµ',
        subs: [{
            name: 'Amplas',
            url: 'https://atcs.medan.id/hls/amplas.m3u8'
          },
          {
            name: 'Belawan',
            url: 'https://cctv.jasamarga.com/hls/belawan.m3u8'
          },
          {
            name: 'GT TJ Morawa',
            url: 'https://jmlive.jasamarga.com/hls/24/a4776165-5356-4edf-ac12-2a1f1fc0fb00/index.m3u8'
          },
          {
            name: 'Maimun',
            url: 'https://atcs.medan.id/hls/maimun.m3u8'
          },
          {
            name: 'Simpang Pos',
            url: 'https://atcs.medan.id/hls/simpangpos.m3u8'
          }
        ]
      }
    ];
    // ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    class TrafficApp {
      constructor() {
        this.video = document.getElementById('main-video');
        this.loader = document.getElementById('loader');
        this.errBox = document.getElementById('error-overlay');
        this.playBox = document.getElementById('play-overlay');
        this.hls = null;
        this.currentUrl = null;
        this.fatalCount = 0;
        this.autoplayBlocked = false;
        this.isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        this.isAndroid = /Android/i.test(navigator.userAgent);
        this._toggleBusy = false;
        this._playBusy = false;
        // Recording State
        this.mediaRecorder = null;
        this.recordedChunks = [];
        this.isRecording = false;
        this.recordingStartTime = null;
        this.recordingTimer = null;
        this.segmentTimer = null;
        this.currentLocationName = 'CCTV';
        this.segmentCount = 0;
        this.canvasFrameTimer = null;
        // Canvas for recording with watermark
        this.recordingCanvas = document.getElementById('recording-canvas');
        this.recordingCtx = this.recordingCanvas.getContext('2d');
        this.watermarkLogo = document.getElementById('watermark-logo');
        // Enhancement State
        this.hdEnabled = false;
        this.sharpnessLevel = 1;
        // Supported MIME types (prioritize MP4/H.264 for mobile compatibility)
        this.supportedMimeTypes = [
          'video/mp4;codecs=h264,aac',
          'video/mp4;codecs=h264',
          'video/webm;codecs=h264,opus',
          'video/webm;codecs=h264',
          'video/webm;codecs=vp9,opus',
          'video/webm;codecs=vp8,opus',
          'video/webm;codecs=vp9',
          'video/webm;codecs=vp8',
          'video/webm'
        ];
        this._init();
      }
      _init() {
        this._renderMenu();
        this._setupSearch();
        this._setupStaticBtns();
        this._setupVideoWatchdog();
        this._setupRecordingControls();
        this._setupEnhancementControls();
        this._checkSupportedFormats();
        document.getElementById('status-bar').textContent = 'CCTV MUDIK 2026';
      }
      _setupStaticBtns() {
        document.getElementById('play-btn').addEventListener('click', () => this._manualPlay());
        document.getElementById('retry-btn').addEventListener('click', () => this._retry());
        document.getElementById('fs-btn').addEventListener('click', () => this._toggleFS());
      }
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // CHECK SUPPORTED FORMATS
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      _checkSupportedFormats() {
        let supportedFormat = 'WebM/VP9';
        for (const mime of this.supportedMimeTypes) {
          if (MediaRecorder.isTypeSupported(mime)) {
            if (mime.includes('mp4')) {
              supportedFormat = 'MP4/H.264';
              break;
            } else if (mime.includes('h264')) {
              supportedFormat = 'H.264/WebM';
              break;
            }
          }
        }
        document.getElementById('format-badge').textContent = supportedFormat;
      }
      _getBestMimeType() {
        for (const mime of this.supportedMimeTypes) {
          if (MediaRecorder.isTypeSupported(mime)) {
            return mime;
          }
        }
        return 'video/webm';
      }
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // RECORDING WITH WATERMARK (CANVAS APPROACH)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      _setupRecordingControls() {
        const recBtn = document.getElementById('main-rec-btn');
        recBtn.addEventListener('click', () => this._toggleRecording());
      }
      _toggleRecording() {
        if (this.isRecording) {
          this._stopRecording();
        } else {
          this._startRecording();
        }
      }
      _startRecording() {
        try {
          // Check if video is ready
          if (!this.video || this.video.readyState < 2) {
            this._showToast('Video belum siap untuk direkam', 'error');
            return;
          }
          // Get video dimensions
          const videoWidth = this.video.videoWidth || 1280;
          const videoHeight = this.video.videoHeight || 720;
          // Setup canvas for recording with watermark
          this.recordingCanvas.width = videoWidth;
          this.recordingCanvas.height = videoHeight;
          // Start canvas frame rendering
          this._startCanvasRendering();
          // Get stream from canvas (with watermark already drawn)
          let stream;
          try {
            stream = this.recordingCanvas.captureStream(30); // 30 FPS
          } catch (e) {
            this._showToast('Browser tidak mendukung perekaman canvas', 'error');
            return;
          }
          // Try to add audio track if available
          try {
            if (this.video.captureStream) {
              const videoStream = this.video.captureStream();
              const audioTracks = videoStream.getAudioTracks();
              if (audioTracks.length > 0) {
                stream.addTrack(audioTracks[0]);
              }
            } else if (this.video.mozCaptureStream) {
              const videoStream = this.video.mozCaptureStream();
              const audioTracks = videoStream.getAudioTracks();
              if (audioTracks.length > 0) {
                stream.addTrack(audioTracks[0]);
              }
            }
          } catch (e) {
            console.warn('Could not add audio track:', e);
          }
          // Get best MIME type
          const mimeType = this._getBestMimeType();
          // Recording options
          const options = {
            mimeType: mimeType,
            videoBitsPerSecond: 2500000, // 2.5 Mbps for good quality
            audioBitsPerSecond: 128000
          };
          // Create MediaRecorder
          try {
            this.mediaRecorder = new MediaRecorder(stream, options);
          } catch (e) {
            console.warn('MediaRecorder with options failed:', e);
            // Fallback without options
            this.mediaRecorder = new MediaRecorder(stream);
          }
          this.recordedChunks = [];
          this.segmentCount++;
          // Handle data available
          this.mediaRecorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0) {
              this.recordedChunks.push(event.data);
            }
          };
          // Handle stop
          this.mediaRecorder.onstop = () => {
            this._downloadSegment();
          };
          // Handle errors
          this.mediaRecorder.onerror = (event) => {
            console.error('MediaRecorder error:', event.error);
            this._showToast('Error perekaman: ' + event.error.message, 'error');
            this._resetRecordingState();
          };
          // Get segment duration
          const durationSelect = document.getElementById('segment-duration');
          const segmentDuration = parseInt(durationSelect.value);
          // Start recording
          this.mediaRecorder.start(segmentDuration);
          this.isRecording = true;
          this.recordingStartTime = Date.now();
          // Update UI
          this._updateRecordingUI(true);
          // Start timer display
          this._startTimerDisplay();
          // Set up segment auto-download timer
          this.segmentTimer = setTimeout(() => {
            if (this.isRecording) {
              this._saveSegmentAndContinue();
            }
          }, segmentDuration);
          this._showToast('‚óè Perekaman dimulai (dengan watermark)', 'success');
        } catch (error) {
          console.error('Failed to start recording:', error);
          this._showToast('Gagal memulai perekaman: ' + error.message, 'error');
          this._resetRecordingState();
        }
      }
      // Canvas rendering with watermark
      _startCanvasRendering() {
        const drawFrame = () => {
          if (!this.isRecording) return;
          const ctx = this.recordingCtx;
          const canvas = this.recordingCanvas;
          const video = this.video;
          // Clear canvas
          ctx.fillStyle = '#000';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          // Draw video frame (maintaining aspect ratio)
          const videoAspect = video.videoWidth / video.videoHeight;
          const canvasAspect = canvas.width / canvas.height;
          let drawWidth, drawHeight, drawX, drawY;
          if (videoAspect > canvasAspect) {
            drawWidth = canvas.width;
            drawHeight = canvas.width / videoAspect;
            drawX = 0;
            drawY = (canvas.height - drawHeight) / 2;
          } else {
            drawHeight = canvas.height;
            drawWidth = canvas.height * videoAspect;
            drawX = (canvas.width - drawWidth) / 2;
            drawY = 0;
          }
          // Apply HD enhancement filter to canvas if enabled
          if (this.hdEnabled) {
            ctx.filter = `contrast(${1.1 + this.sharpnessLevel * 0.03}) brightness(${1.05 + this.sharpnessLevel * 0.01}) saturate(${1.1 + this.sharpnessLevel * 0.02})`;
          } else {
            ctx.filter = 'none';
          }
          ctx.drawImage(video, drawX, drawY, drawWidth, drawHeight);
          ctx.filter = 'none';
          // Draw watermark logo
          if (this.watermarkLogo && this.watermarkLogo.complete) {
            const logoSize = Math.min(canvas.width, canvas.height) * 0.12; // 12% of smaller dimension
            const logoX = canvas.width - logoSize - 15;
            const logoY = 15;
            // Add semi-transparent background for logo
            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
            ctx.beginPath();
            ctx.roundRect(logoX - 5, logoY - 5, logoSize + 10, logoSize + 10, 8);
            ctx.fill();
            // Draw logo with transparency
            ctx.globalAlpha = 0.8;
            ctx.drawImage(this.watermarkLogo, logoX, logoY, logoSize, logoSize);
            ctx.globalAlpha = 1.0;
          }
          // Draw recording timestamp
          const elapsed = Date.now() - this.recordingStartTime;
          const timeStr = this._formatTime(elapsed);
          const dateStr = new Date().toLocaleDateString('id-ID');
          const locStr = this.currentLocationName.substring(0, 25);
          // Timestamp background
          ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
          ctx.fillRect(10, canvas.height - 50, 280, 40);
          // Timestamp text
          ctx.font = 'bold 14px Arial, sans-serif';
          ctx.fillStyle = '#ef4444';
          ctx.fillText(`‚óè REC ${timeStr}`, 20, canvas.height - 30);
          ctx.font = '12px Arial, sans-serif';
          ctx.fillStyle = '#ffffff';
          ctx.fillText(`${locStr} | ${dateStr}`, 20, canvas.height - 15);
          // Continue rendering
          this.canvasFrameTimer = requestAnimationFrame(drawFrame);
        };
        drawFrame();
      }
      _stopCanvasRendering() {
        if (this.canvasFrameTimer) {
          cancelAnimationFrame(this.canvasFrameTimer);
          this.canvasFrameTimer = null;
        }
      }
      _updateRecordingUI(isRecording) {
        const recBtn = document.getElementById('main-rec-btn');
        const recStatusItem = document.getElementById('rec-status-item');
        const recordingHud = document.getElementById('recording-hud');
        if (isRecording) {
          recBtn.className = 'main-rec-btn stop';
          recBtn.innerHTML = `
            <svg fill="currentColor" viewBox="0 0 24 24">
              <rect x="6" y="6" width="12" height="12" rx="2"/>
            </svg>
            <span>STOP REKAM</span>
          `;
          recStatusItem.style.display = 'flex';
          recordingHud.classList.add('active');
        } else {
          recBtn.className = 'main-rec-btn start';
          recBtn.innerHTML = `
            <svg fill="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="8"/>
            </svg>
            <span>MULAI REKAM</span>
          `;
          recStatusItem.style.display = 'none';
          recordingHud.classList.remove('active');
        }
      }
      _stopRecording() {
        if (this.mediaRecorder && this.isRecording) {
          // Clear segment timer
          if (this.segmentTimer) {
            clearTimeout(this.segmentTimer);
            this.segmentTimer = null;
          }
          // Stop canvas rendering
          this._stopCanvasRendering();
          // Stop the recorder
          this.mediaRecorder.stop();
          this._resetRecordingState();
          this._showToast('‚ñ† Perekaman dihentikan', 'info');
        }
      }
      _saveSegmentAndContinue() {
        if (!this.isRecording || !this.mediaRecorder) return;
        this.mediaRecorder.requestData();
        setTimeout(() => {
          if (this.recordedChunks.length > 0) {
            this._downloadSegment();
            this.recordedChunks = [];
            this.segmentCount++;
            const durationSelect = document.getElementById('segment-duration');
            const segmentDuration = parseInt(durationSelect.value);
            this.segmentTimer = setTimeout(() => {
              if (this.isRecording) {
                this._saveSegmentAndContinue();
              }
            }, segmentDuration);
          }
        }, 100);
      }
      _downloadSegment() {
        if (this.recordedChunks.length === 0) return;
        // Determine file extension based on MIME type
        const mimeType = this._getBestMimeType();
        let extension = 'webm';
        let actualMimeType = 'video/webm';
        if (mimeType.includes('mp4')) {
          extension = 'mp4';
          actualMimeType = 'video/mp4';
        }
        const blob = new Blob(this.recordedChunks, {
          type: actualMimeType
        });
        const url = URL.createObjectURL(blob);
        // Generate filename
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
        const cleanLocation = this.currentLocationName
          .replace(/[^a-zA-Z0-9_-]/g, '_')
          .replace(/_+/g, '_')
          .substring(0, 30);
        const filename = `${cleanLocation}_${dateStr}_${timeStr}.${extension}`;
        // Download
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        // Revoke URL
        setTimeout(() => {
          URL.revokeObjectURL(url);
        }, 1000);
        this._showToast(`‚úì Disimpan: ${filename}`, 'success');
        this.recordedChunks = [];
      }
      _startTimerDisplay() {
        const timerEl = document.getElementById('rec-timer');
        this.recordingTimer = setInterval(() => {
          if (!this.isRecording) {
            clearInterval(this.recordingTimer);
            return;
          }
          const elapsed = Date.now() - this.recordingStartTime;
          timerEl.textContent = this._formatTime(elapsed);
        }, 1000);
      }
      _formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return [hours, minutes, seconds]
          .map(v => v.toString().padStart(2, '0'))
          .join(':');
      }
      _resetRecordingState() {
        this.isRecording = false;
        this._stopCanvasRendering();
        if (this.recordingTimer) {
          clearInterval(this.recordingTimer);
          this.recordingTimer = null;
        }
        if (this.segmentTimer) {
          clearTimeout(this.segmentTimer);
          this.segmentTimer = null;
        }
        this._updateRecordingUI(false);
        document.getElementById('rec-timer').textContent = '00:00:00';
      }
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // VIDEO ENHANCEMENT
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      _setupEnhancementControls() {
        const hdBtn = document.getElementById('hd-toggle-btn');
        const sharpSlider = document.getElementById('sharpness-slider');
        const sharpValue = document.getElementById('sharpness-value');
        hdBtn.addEventListener('click', () => {
          this.hdEnabled = !this.hdEnabled;
          const hdStatusDot = document.getElementById('hd-status-dot');
          const hdStatusText = document.getElementById('hd-status-text');
          if (this.hdEnabled) {
            this.video.classList.add('hd-enhanced');
            hdBtn.classList.add('active');
            hdBtn.innerHTML = `
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              <span>HD ON</span>
            `;
            this._applySharpness(this.sharpnessLevel);
            hdStatusDot.classList.add('hd');
            hdStatusText.textContent = 'HD ON';
          } else {
            this.video.classList.remove('hd-enhanced');
            this.video.style.filter = '';
            hdBtn.classList.remove('active');
            hdBtn.innerHTML = `
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              <span>HD</span>
            `;
            hdStatusDot.classList.remove('hd');
            hdStatusText.textContent = 'HD OFF';
          }
        });
        sharpSlider.addEventListener('input', (e) => {
          this.sharpnessLevel = parseFloat(e.target.value);
          sharpValue.textContent = this.sharpnessLevel.toFixed(1);
          if (this.hdEnabled) {
            this._applySharpness(this.sharpnessLevel);
          }
        });
      }
      _applySharpness(level) {
        const contrast = 1.1 + (level * 0.03);
        const brightness = 1.05 + (level * 0.01);
        const saturate = 1.1 + (level * 0.02);
        this.video.style.filter = `
          contrast(${contrast})
          brightness(${brightness})
          saturate(${saturate})
        `;
      }
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // UTILITY FUNCTIONS
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      _showToast(message, type = 'info') {
        const toast = document.getElementById('segment-toast');
        toast.textContent = message;
        if (type === 'success') {
          toast.style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(22, 163, 74, 0.95) 100%)';
        } else if (type === 'error') {
          toast.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(220, 38, 38, 0.95) 100%)';
        } else {
          toast.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(37, 99, 235, 0.95) 100%)';
        }
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }
      _renderMenu() {
        const container = document.getElementById('menu-container');
        container.innerHTML = categories.map(cat => `
        <div class="category-group">
          <button class="category-btn" data-action="toggle" data-id="${cat.id}">
            <span class="cat-label">
              <span class="cat-icon">${cat.icon}</span>
              ${cat.name}
            </span>
            <svg class="chevron-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div id="sub-${cat.id}" class="submenu-container" style="display:grid;gap:6px">
            ${cat.subs.map(sub => `
              <button class="sub-btn"
                data-action="play"
                data-cat="${cat.name}"
                data-sub="${sub.name}"
                data-url="${sub.url}">
                ${sub.name}
              </button>
            `).join('')}
          </div>
        </div>
      `).join('');
        container.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-action]');
          if (!btn) return;
          const action = btn.dataset.action;
          if (action === 'toggle') {
            this._toggleSub(btn.dataset.id, btn);
          } else if (action === 'play') {
            this._playSub(btn.dataset.cat, btn.dataset.sub, btn.dataset.url, btn);
          }
        });
      }
      _toggleSub(id, btn) {
        if (this._toggleBusy) return;
        this._toggleBusy = true;
        setTimeout(() => {
          this._toggleBusy = false;
        }, 450);
        const panel = document.getElementById('sub-' + id);
        if (!panel) return;
        const isOpen = panel.classList.contains('open');
        document.querySelectorAll('.submenu-container.open').forEach(p => p.classList.remove('open'));
        document.querySelectorAll('.category-btn.is-open').forEach(b => b.classList.remove('is-open'));
        if (!isOpen) {
          panel.classList.add('open');
          btn.classList.add('is-open');
          if (this.isMobile) {
            setTimeout(() => {
              btn.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest'
              });
            }, 150);
          }
        }
      }
      _playSub(cat, sub, url, btn) {
        if (!url || url === '#') {
          this._showError('Stream channel ini belum tersedia.');
          return;
        }
        if (this._playBusy) return;
        if (url === this.currentUrl) return;
        if (this.isRecording) {
          this._stopRecording();
        }
        this._playBusy = true;
        setTimeout(() => {
          this._playBusy = false;
        }, 700);
        this.currentUrl = url;
        this.fatalCount = 0;
        this.autoplayBlocked = false;
        this.currentLocationName = sub;
        document.getElementById('location-name').textContent = sub;
        document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active-btn'));
        btn.classList.add('active-btn');
        document.getElementById('display-title').textContent = `${cat} ‚Äî ${sub}`;
        document.getElementById('display-sub').textContent = url.split('/').pop();
        // Show recording panel
        document.getElementById('recording-panel').classList.add('visible');
        this._showLoader();
        this._destroyHls();
        if (Hls.isSupported()) {
          this._loadHls(url);
        } else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
          this._loadNative(url);
        } else {
          this._showError('Browser tidak mendukung HLS. Gunakan Chrome terbaru.');
        }
      }
      _loadHls(url) {
        const cfg = {
          enableWorker: false,
          lowLatencyMode: false,
          maxBufferLength: 10,
          maxMaxBufferLength: 25,
          maxBufferSize: 10 * 1000 * 1000,
          backBufferLength: 5,
          maxBufferHole: 1.0,
          nudgeOffset: 0.3,
          nudgeMaxRetry: 6,
          startFragPrefetch: false,
          testBandwidth: false,
          xhrSetup(xhr) {
            xhr.withCredentials = false;
          },
          manifestLoadingTimeOut: 14000,
          manifestLoadingMaxRetry: 3,
          manifestLoadingRetryDelay: 2000,
          levelLoadingTimeOut: 14000,
          levelLoadingMaxRetry: 3,
          levelLoadingRetryDelay: 2000,
          fragLoadingTimeOut: 20000,
          fragLoadingMaxRetry: 4,
          fragLoadingRetryDelay: 2000,
          startLevel: -1,
          abrEwmaFastLive: 5,
          abrEwmaSlowLive: 12,
          abrBandWidthFactor: 0.75,
          abrBandWidthUpFactor: 0.5,
          debug: false,
        };
        const hls = new Hls(cfg);
        this.hls = hls;
        hls.loadSource(url);
        hls.attachMedia(this.video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          this._hideLoader();
          this._tryPlay();
        });
        hls.on(Hls.Events.ERROR, (_, data) => {
          if (!data.fatal) return;
          this.fatalCount++;
          console.warn('[HLS Fatal]', data.type, data.details, '#' + this.fatalCount);
          if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
            if (this.fatalCount <= 3) {
              const delay = this.isAndroid ? 2500 : 1200;
              setTimeout(() => {
                if (this.hls) hls.startLoad();
              }, delay);
            } else {
              this._showError(
                'Gagal memuat stream.\n' +
                'Kemungkinan penyebab:\n' +
                '‚Ä¢ Stream offline\n' +
                '‚Ä¢ CORS diblokir server\n' +
                '‚Ä¢ Koneksi tidak stabil\n\n' +
                'Coba channel lain atau tekan Coba Lagi.'
              );
              hls.destroy();
            }
          } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
            if (this.fatalCount <= 2) {
              hls.recoverMediaError();
            } else {
              this._showError('Format media tidak didukung: ' + data.details);
              hls.destroy();
            }
          } else {
            this._showError('Error: ' + data.details + '\nCoba channel lain.');
            hls.destroy();
          }
        });
      }
      _loadNative(url) {
        this.video.src = url;
        this.video.load();
        this.video.addEventListener('loadedmetadata', () => {
          this._hideLoader();
          this._tryPlay();
        }, {
          once: true
        });
        this.video.addEventListener('error', () => {
          const c = this.video.error ? this.video.error.code : '?';
          this._showError('Playback error (kode: ' + c + '). Stream offline atau CORS.');
        }, {
          once: true
        });
        setTimeout(() => {
          if (this.loader.classList.contains('show')) {
            this._showError('Timeout: stream tidak merespons dalam 15 detik.');
          }
        }, 15000);
      }
      _tryPlay() {
        const p = this.video.play();
        if (p instanceof Promise) {
          p.then(() => {
            this.autoplayBlocked = false;
            this.playBox.classList.remove('show');
          }).catch(err => {
            console.warn('[Autoplay blocked]', err.message);
            this.autoplayBlocked = true;
            this._hideLoader();
            this.playBox.classList.add('show');
          });
        }
      }
      _manualPlay() {
        this.playBox.classList.remove('show');
        this.autoplayBlocked = false;
        this.video.play().catch(() => {
          if (this.currentUrl) this._retry();
        });
      }
      _setupVideoWatchdog() {
        this.video.addEventListener('stalled', () => {
          if (!this.currentUrl) return;
          setTimeout(() => {
            if (this.video.readyState < 3 && !this.video.paused) {
              this.video.play().catch(() => {});
            }
          }, 5000);
        });
        this.video.addEventListener('pause', () => {
          if (this.autoplayBlocked || !this.currentUrl || this.video.ended) return;
          setTimeout(() => {
            if (this.video.paused && !this.autoplayBlocked && this.currentUrl) {
              this.video.play().catch(() => {});
            }
          }, 1200);
        });
      }
      _destroyHls() {
        if (this.hls) {
          this.hls.destroy();
          this.hls = null;
        }
        this.video.pause();
        this.video.removeAttribute('src');
        this.video.load();
      }
      _showLoader() {
        this.loader.classList.add('show');
        this.errBox.classList.remove('show');
        this.playBox.classList.remove('show');
      }
      _hideLoader() {
        this.loader.classList.remove('show');
      }
      _showError(msg) {
        this._hideLoader();
        this.playBox.classList.remove('show');
        this.errBox.classList.add('show');
        document.getElementById('error-detail').textContent = msg || 'Stream tidak tersedia.';
      }
      _retry() {
        if (!this.currentUrl || this.currentUrl === '#') return;
        const url = this.currentUrl;
        this.currentUrl = null;
        this.fatalCount = 0;
        this.autoplayBlocked = false;
        this._showLoader();
        this._destroyHls();
        setTimeout(() => {
          this.currentUrl = url;
          if (Hls.isSupported()) this._loadHls(url);
          else this._loadNative(url);
        }, 800);
      }
      _setupSearch() {
        document.getElementById('cctv-search').addEventListener('input', e => {
          const q = e.target.value.toLowerCase().trim();
          document.querySelectorAll('.category-group').forEach(g => {
            g.style.display = (!q || g.textContent.toLowerCase().includes(q)) ? '' : 'none';
          });
        });
      }
      _toggleFS() {
        const target = this.isMobile ? this.video : document.getElementById('video-box');
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
          const fn = target.requestFullscreen || target.webkitRequestFullscreen;
          if (fn) fn.call(target).catch(() => {
            if (this.video.requestFullscreen) this.video.requestFullscreen().catch(() => {});
          });
        } else {
          const fn = document.exitFullscreen || document.webkitExitFullscreen;
          if (fn) fn.call(document);
        }
      }
    }
    // Initialize
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        window.app = new TrafficApp();
      });
    } else {
      window.app = new TrafficApp();
    }
  </script>
</body>

</html>
