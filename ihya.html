<!DOCTYPE html>
<html lang="id" dir="rtl">
<!-- Assuming RTL for Arabic content, adjust if needed -->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>Kitab Digital Ihya Ulumuddin</title>
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <!-- iOS support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Ihya Ulumuddin">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png"> <!-- Assume you have icons -->
  <!-- Theme color -->
  <meta name="theme-color" content="#f4ecd8">
  <style>
    body {
      margin: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Noto Naskh Arabic', serif;
      /* Modern Arabic font for professionalism */
      background:
        radial-gradient(circle at 20% 20%, rgba(0, 0, 0, 0.03), transparent 40%),
        radial-gradient(circle at 80% 80%, rgba(0, 0, 0, 0.04), transparent 40%),
        #f4ecd8;
      /* Parchment background */
      color: #333;
      transition: background-color 0.3s, filter 0.3s;
      /* For night mode */
    }

    .night-mode {
      background: #1e1e1e !important;
      filter: invert(1) hue-rotate(180deg);
      /* Simple night mode for images */
      color: #ccc;
    }

    .night-mode .nav {
      background: rgba(0, 0, 0, 0.8);
    }

    .night-mode .page-number {
      color: #ccc;
    }

    .night-mode button {
      color: #aaa;
    }

    .night-mode button:hover {
      color: #fff;
    }

    .viewer {
      width: 100%;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      position: relative;
    }

    .page-wrapper {
      touch-action: none;
      position: relative;
      transition: transform 0.8s ease-out, opacity 0.8s ease-out;
      /* Smoother transition for floating */
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      will-change: transform, opacity;
      /* Optimize for animation */
    }

    .page {
      width: auto;
      height: auto;
      max-width: 100vw;
      /* Full width on mobile */
      max-height: 100vh;
      object-fit: contain;
      box-shadow:
        0 30px 60px rgba(0, 0, 0, 0.25),
        inset 0 0 60px rgba(0, 0, 0, 0.08);
      border-radius: 4px;
      /* Softer corners */
      transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
      backface-visibility: hidden;
      transform-style: preserve-3d;
      margin: auto;
      /* Extra centering */
    }

    .page:hover {
      box-shadow: 0 40px 80px rgba(0, 0, 0, 0.3);
      /* Hover effect for interactivity */
    }

    /* Keyframes for floating away animation (shrink and fade out) */
    @keyframes shrinkAwayNext {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }

      100% {
        transform: translateY(-50px) scale(0.6) rotate(5deg);
        opacity: 0;
      }
    }

    @keyframes shrinkAwayPrev {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }

      100% {
        transform: translateY(-50px) scale(0.6) rotate(-5deg);
        opacity: 0;
      }
    }

    /* Keyframes for floating in animation (grow from small to full) */
    @keyframes growIn {
      0% {
        transform: translateY(50px) scale(0.6);
        opacity: 0;
      }

      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* Navigation controls */
    .nav {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px 20px;
      border-radius: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 10;
      transition: opacity 0.5s;
      /* For hiding nav */
    }

    .nav-hidden {
      opacity: 0;
      pointer-events: none;
    }

    .nav button {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0 15px;
      color: #555;
      transition: color 0.2s;
    }

    .nav button:hover {
      color: #000;
    }

    .page-number {
      font-size: 16px;
      margin: 0 20px;
      color: #333;
    }

    /* Progress bar */
    .progress {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 50%;
      height: 4px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 2px;
      z-index: 10;
      transition: opacity 0.5s;
      /* For hiding */
    }

    .progress-hidden {
      opacity: 0;
      pointer-events: none;
    }

    .progress-bar {
      height: 100%;
      background: #8b4513;
      /* Brown for book theme */
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    /* Bookmark indicator */
    .bookmark {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
      color: #ccc;
      transition: color 0.2s, opacity 0.5s;
    }

    .bookmark-hidden {
      opacity: 0;
      pointer-events: none;
    }

    .bookmarked {
      color: #ff0000;
      /* Red for bookmarked */
    }

    /* Jump to page modal */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      z-index: 20;
    }

    .modal input {
      width: 100px;
      margin-right: 10px;
    }

    /* Responsive adjustments */
    @media (min-width: 768px) {
      .page {
        max-width: 70%;
        /* Adjusted for desktop, slightly larger */
      }
    }

    /* Font import for professionalism */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap');
  </style>
</head>

<body>
  <div class="viewer">
    <div class="page-wrapper" id="wrapper">
      <img id="page" class="page" alt="Halaman Kitab">
    </div>
  </div>
  <!-- Navigation -->
  <div class="nav" id="nav">
    <button onclick="prevPage()">&#9664;</button> <!-- Left arrow -->
    <span class="page-number" id="pageNum">1 / 600</span>
    <button onclick="nextPage()">&#9654;</button> <!-- Right arrow -->
    <button onclick="toggleNightMode()">üåô</button> <!-- Night mode -->
    <button onclick="showJumpModal()">üîç</button> <!-- Jump to page -->
    <button onclick="toggleZoomLock()">üîí</button> <!-- New lock zoom button -->
  </div>
  <!-- Progress bar -->
  <div class="progress" id="progress">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <!-- Bookmark -->
  <div class="bookmark" id="bookmark" onclick="toggleBookmark()">üîñ</div>
  <!-- Jump modal -->
  <div class="modal" id="jumpModal">
    <label for="jumpPage">Jump to page:</label>
    <input type="number" id="jumpPage" min="1" max="600">
    <button onclick="jumpToPage()">Go</button>
    <button onclick="closeModal()">Close</button>
  </div>
  <script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('Service Worker registered', reg))
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }
    // Jumlah halaman
    const TOTAL_PAGES = 600; // Ganti sesuai jumlah file WebP
    let currentPage = parseInt(localStorage.getItem("ihya-page")) || 0;
    let bookmarks = JSON.parse(localStorage.getItem("ihya-bookmarks")) || [];
    // Zoom & drag - persistent across pages
    let scale = parseFloat(localStorage.getItem("ihya-scale")) || 1;
    let translateX = parseFloat(localStorage.getItem("ihya-translateX")) || 0;
    let translateY = parseFloat(localStorage.getItem("ihya-translateY")) || 0;
    // New: Zoom lock feature
    let isZoomLocked = localStorage.getItem("ihya-zoom-locked") === 'true';
    let lockedScale = parseFloat(localStorage.getItem("ihya-locked-scale")) || 1;
    let lockedTranslateX = 0;
    let lockedTranslateY = 0;
    // Swipe & mouse
    let startX = 0;
    let startY = 0;
    let startTime = 0;
    let velocity = 0;
    let initialDistance = 0;
    let startDragX = 0;
    let startDragY = 0;
    let isDragging = false;
    const img = document.getElementById('page');
    const wrapper = document.getElementById('wrapper');
    const pageNum = document.getElementById('pageNum');
    const progressBar = document.getElementById('progressBar');
    const bookmarkIcon = document.getElementById('bookmark');
    const jumpModal = document.getElementById('jumpModal');
    const jumpInput = document.getElementById('jumpPage');
    const nav = document.getElementById('nav');
    const progress = document.getElementById('progress');
    let hideUITimer;

    function pad(num) {
      return num.toString().padStart(4, '0');
    }

    function savePosition() {
      localStorage.setItem("ihya-page", currentPage);
      localStorage.setItem("ihya-scale", scale);
      localStorage.setItem("ihya-translateX", translateX);
      localStorage.setItem("ihya-translateY", translateY);
      localStorage.setItem("ihya-zoom-locked", isZoomLocked);
      if (isZoomLocked) {
        localStorage.setItem("ihya-locked-scale", lockedScale);
      }
    }

    function updatePageInfo() {
      pageNum.textContent = `${currentPage + 1} / ${TOTAL_PAGES}`;
      progressBar.style.width = `${((currentPage + 1) / TOTAL_PAGES) * 100}%`;
      updateBookmarkIcon();
    }
    // Fungsi untuk memuat halaman dengan zoom persist (tidak reset setiap ganti halaman)
    function loadPage(n, resetZoom = false) {
      if (resetZoom) {
        scale = 1;
        translateX = 0;
        translateY = 0;
      }
      // Jika zoom locked, apply locked zoom
      if (isZoomLocked) {
        scale = lockedScale;
        translateX = lockedTranslateX;
        translateY = lockedTranslateY;
      }
      // Apply zoom and translation
      updateTransform();
      img.src = `assets/ihya/${pad(n)}.webp`;
      savePosition();
      updatePageInfo();
      if (n + 1 < TOTAL_PAGES) {
        const preload = new Image();
        preload.src = `assets/ihya/${pad(n+1)}.webp`;
      }
      if (n - 1 >= 0) {
        const preloadPrev = new Image();
        preloadPrev.src = `assets/ihya/${pad(n-1)}.webp`;
      }
      // Auto-fit to max zoom only if scale is default (1) and not locked
      if (scale === 1 && !isZoomLocked) {
        fitToMaxZoom();
      }
      // Animate new page growing in from small
      wrapper.style.animation = 'growIn 0.8s ease-out forwards';
      setTimeout(() => {
        wrapper.style.animation = '';
      }, 800);
    }
    // Fungsi untuk memperbesar tampilan awal hingga batas maksimal (ditingkatkan ke 10 untuk lebih besar)
    function fitToMaxZoom() {
      // Wait for image to load to calculate dimensions
      img.onload = () => {
        const viewerRect = document.querySelector('.viewer').getBoundingClientRect();
        const imgWidth = img.naturalWidth;
        const imgHeight = img.naturalHeight;
        const scaleX = viewerRect.width / imgWidth;
        const scaleY = viewerRect.height / imgHeight;
        scale = Math.max(scaleX, scaleY) * 1.5; // Amplify zoom by 1.5x untuk lebih besar dari ukuran saat ini
        scale = Math.min(scale, 10); // Batas maksimal zoom ditingkatkan ke 10
        translateX = 0;
        translateY = 0;
        updateTransform();
        savePosition();
      };
    }
    // New: Toggle zoom lock
    function toggleZoomLock() {
      isZoomLocked = !isZoomLocked;
      if (isZoomLocked) {
        lockedScale = scale;
        lockedTranslateX = translateX;
        lockedTranslateY = translateY;
      }
      savePosition();
      // Optional: Update button style or icon if needed
      const lockBtn = document.querySelector('button[onclick="toggleZoomLock()"]');
      lockBtn.textContent = isZoomLocked ? 'üîí' : 'üîì';
    }

    function nextPage() {
      if (currentPage < TOTAL_PAGES - 1) {
        animateShrink('next', () => {
          currentPage++;
          loadPage(currentPage, false); // Jangan reset zoom
          wrapper.style.transition = "none";
          wrapper.style.transform = "translateY(0) scale(1)";
          wrapper.style.opacity = 1;
        });
      }
    }

    function prevPage() {
      if (currentPage > 0) {
        animateShrink('prev', () => {
          currentPage--;
          loadPage(currentPage, false); // Jangan reset zoom
          wrapper.style.transition = "none";
          wrapper.style.transform = "translateY(0) scale(1)";
          wrapper.style.opacity = 1;
        });
      }
    }

    function animateShrink(direction, callback) {
      const animName = direction === 'next' ? 'shrinkAwayNext' : 'shrinkAwayPrev';
      wrapper.style.animation = `${animName} 0.8s ease-out forwards`;
      setTimeout(callback, 800);
    }

    function updateTransform() {
      img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }
    loadPage(currentPage);
    // Touch events
    wrapper.addEventListener('touchstart', e => {
      startTime = Date.now();
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      if (e.touches.length === 2) {
        initialDistance = getDistance(e.touches[0], e.touches[1]);
      } else if (scale > 1) {
        startDragX = startX - translateX;
        startDragY = startY - translateY;
      }
      showUI(); // Show UI on touch
    });
    wrapper.addEventListener('touchmove', e => {
      if (e.touches.length === 2) {
        let currentDistance = getDistance(e.touches[0], e.touches[1]);
        let diff = currentDistance - initialDistance;
        scale += diff / 300;
        scale = Math.max(1, Math.min(scale, 5));
        initialDistance = currentDistance;
        updateTransform();
        savePosition(); // Save new scale
      } else if (e.touches.length === 1 && scale > 1) {
        translateX = e.touches[0].clientX - startDragX;
        translateY = e.touches[0].clientY - startDragY;
        updateTransform();
      }
    });
    wrapper.addEventListener('touchend', e => {
      if (scale === 1) {
        let diffX = e.changedTouches[0].clientX - startX;
        let time = Date.now() - startTime;
        velocity = diffX / time;
        if (diffX < -50 || velocity < -0.5) {
          nextPage();
        } else if (diffX > 50 || velocity > 0.5) {
          prevPage();
        }
      }
      scheduleHideUI();
    });
    // Double tap to reset zoom only if zoomed in
    let lastTap = 0;
    wrapper.addEventListener('touchend', () => {
      let now = Date.now();
      if (now - lastTap < 300 && scale > 1) {
        scale = 1;
        translateX = 0;
        translateY = 0;
        updateTransform();
        savePosition();
      }
      lastTap = now;
    });

    function getDistance(t1, t2) {
      let dx = t1.clientX - t2.clientX;
      let dy = t1.clientY - t2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
    // Mouse support for desktop
    wrapper.addEventListener('mousedown', e => {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      startDragX = startX - translateX;
      startDragY = startY - translateY;
      wrapper.style.cursor = 'grabbing';
      showUI();
    });
    document.addEventListener('mousemove', e => {
      if (isDragging && scale > 1) {
        translateX = e.clientX - startDragX;
        translateY = e.clientY - startDragY;
        updateTransform();
      }
    });
    document.addEventListener('mouseup', () => {
      isDragging = false;
      wrapper.style.cursor = 'grab';
      scheduleHideUI();
    });
    // Wheel zoom
    wrapper.addEventListener('wheel', e => {
      e.preventDefault();
      const delta = e.deltaY * -0.01;
      scale += delta;
      scale = Math.max(1, Math.min(scale, 5));
      updateTransform();
      savePosition();
      showUI();
      scheduleHideUI();
    });
    // Keyboard navigation
    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowRight') prevPage(); // RTL: right key for prev
      if (e.key === 'ArrowLeft') nextPage(); // RTL: left key for next
    });
    // Night mode
    function toggleNightMode() {
      document.body.classList.toggle('night-mode');
      localStorage.setItem('ihya-night-mode', document.body.classList.contains('night-mode'));
    }
    if (localStorage.getItem('ihya-night-mode') === 'true') {
      document.body.classList.add('night-mode');
    }
    // Bookmark
    function toggleBookmark() {
      const index = bookmarks.indexOf(currentPage);
      if (index === -1) {
        bookmarks.push(currentPage);
      } else {
        bookmarks.splice(index, 1);
      }
      localStorage.setItem("ihya-bookmarks", JSON.stringify(bookmarks));
      updateBookmarkIcon();
    }

    function updateBookmarkIcon() {
      if (bookmarks.includes(currentPage)) {
        bookmarkIcon.classList.add('bookmarked');
      } else {
        bookmarkIcon.classList.remove('bookmarked');
      }
    }
    // Jump to page
    function showJumpModal() {
      jumpModal.style.display = 'block';
      jumpInput.value = currentPage + 1;
    }

    function closeModal() {
      jumpModal.style.display = 'none';
    }

    function jumpToPage() {
      let page = parseInt(jumpInput.value) - 1;
      if (page >= 0 && page < TOTAL_PAGES) {
        currentPage = page;
        loadPage(currentPage, false); // Jangan reset zoom saat jump
      }
      closeModal();
    }
    // Fullscreen support
    document.addEventListener('keydown', e => {
      if (e.key === 'f') {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      }
    });
    // Auto-hide UI for immersive reading
    function showUI() {
      nav.classList.remove('nav-hidden');
      progress.classList.remove('progress-hidden');
      bookmarkIcon.classList.remove('bookmark-hidden');
      clearTimeout(hideUITimer);
    }

    function scheduleHideUI() {
      hideUITimer = setTimeout(() => {
        nav.classList.add('nav-hidden');
        progress.classList.add('progress-hidden');
        bookmarkIcon.classList.add('bookmark-hidden');
      }, 3000); // Hide after 3 seconds of inactivity
    }
    // Initial hide after load
    window.addEventListener('load', () => {
      scheduleHideUI();
      // Initial lock button state
      const lockBtn = document.querySelector('button[onclick="toggleZoomLock()"]');
      lockBtn.textContent = isZoomLocked ? 'üîí' : 'üîì';
    });
    // Show on mouse move or touch
    document.addEventListener('mousemove', showUI);
    document.addEventListener('touchstart', showUI);
  </script>
</body>

</html>
