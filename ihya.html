<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>Kitab Digital Ihya Ulumuddin</title>

  <style>
    body {
      margin: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: serif;
      background:
        radial-gradient(circle at 20% 20%, rgba(0, 0, 0, 0.03), transparent 40%),
        radial-gradient(circle at 80% 80%, rgba(0, 0, 0, 0.04), transparent 40%),
        #f4ecd8;
      /* parchment background */
    }

    .viewer {
      width: 100%;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      position: relative;
    }

    .page-wrapper {
      touch-action: none;
      position: relative;
      transition: transform .35s cubic-bezier(.25, .8, .25, 1);
    }

    .page {
      max-width: 100%;
      max-height: 100vh;
      object-fit: contain;
      box-shadow:
        0 30px 60px rgba(0, 0, 0, .25),
        inset 0 0 60px rgba(0, 0, 0, .08);
      border-radius: 8px;
      transition: transform .15s ease;
    }
  </style>
</head>

<body>

  <div class="viewer">
    <div class="page-wrapper" id="wrapper">
      <img id="page" class="page">
    </div>
  </div>

  <script>
    const TOTAL_PAGES = 650; // ganti sesuai jumlah file
    let currentPage = parseInt(localStorage.getItem("ihya-page")) || 0;
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let startX = 0;
    let startTime = 0;
    let velocity = 0;
    let initialDistance = 0;
    let startDragX = 0;
    let startDragY = 0;
    const img = document.getElementById('page');
    const wrapper = document.getElementById('wrapper');

    function pad(num) {
      return num.toString().padStart(4, '0');
    }

    function savePosition() {
      localStorage.setItem("ihya-page", currentPage);
    }

    function loadPage(n) {
      scale = 1;
      translateX = 0;
      translateY = 0;
      updateTransform();
      // Sesuai folder Anda: aset/ihya/
      img.src = `aset/ihya/${pad(n)}.webp`;
      savePosition();
      // preload next page
      if (n + 1 < TOTAL_PAGES) {
        const preload = new Image();
        preload.src = `aset/ihya/${pad(n+1)}.webp`;
      }
    }

    function nextPage() {
      if (currentPage < TOTAL_PAGES - 1) {
        animateSlide(-window.innerWidth, () => {
          currentPage++;
          loadPage(currentPage);
          wrapper.style.transition = "none";
          wrapper.style.transform = "translateX(0)";
        });
      }
    }

    function prevPage() {
      if (currentPage > 0) {
        animateSlide(window.innerWidth, () => {
          currentPage--;
          loadPage(currentPage);
          wrapper.style.transition = "none";
          wrapper.style.transform = "translateX(0)";
        });
      }
    }

    function animateSlide(distance, callback) {
      wrapper.style.transition = "transform .35s cubic-bezier(.25,.8,.25,1)";
      wrapper.style.transform = `translateX(${distance}px)`;
      setTimeout(callback, 350);
    }

    function updateTransform() {
      img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }
    // Load first page
    loadPage(currentPage);
    // TOUCH EVENTS
    wrapper.addEventListener('touchstart', e => {
      startTime = Date.now();
      if (e.touches.length === 2) {
        initialDistance = getDistance(e.touches[0], e.touches[1]);
      } else if (e.touches.length === 1) {
        startX = e.touches[0].clientX;
        if (scale > 1) {
          startDragX = e.touches[0].clientX - translateX;
          startDragY = e.touches[0].clientY - translateY;
        }
      }
    });
    wrapper.addEventListener('touchmove', e => {
      if (e.touches.length === 2) {
        let currentDistance = getDistance(e.touches[0], e.touches[1]);
        let diff = currentDistance - initialDistance;
        scale += diff / 300;
        scale = Math.max(1, Math.min(scale, 5));
        initialDistance = currentDistance;
        updateTransform();
      } else if (e.touches.length === 1 && scale > 1) {
        translateX = e.touches[0].clientX - startDragX;
        translateY = e.touches[0].clientY - startDragY;
        updateTransform();
      }
    });
    wrapper.addEventListener('touchend', e => {
      if (scale === 1) {
        let diff = e.changedTouches[0].clientX - startX;
        let time = Date.now() - startTime;
        velocity = diff / time;
        if (diff < -50 || velocity < -0.5) {
          nextPage();
        } else if (diff > 50 || velocity > 0.5) {
          prevPage();
        }
      }
    });
    // double tap reset zoom
    let lastTap = 0;
    wrapper.addEventListener('touchend', () => {
      let now = Date.now();
      if (now - lastTap < 300) {
        scale = 1;
        translateX = 0;
        translateY = 0;
        updateTransform();
      }
      lastTap = now;
    });

    function getDistance(t1, t2) {
      let dx = t1.clientX - t2.clientX;
      let dy = t1.clientY - t2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
  </script>

</body>

</html>
